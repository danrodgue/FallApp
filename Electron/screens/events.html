<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Eventos - FallApp</title>
  <link rel="stylesheet" href="../css/login.css">
  <link rel="stylesheet" href="../css/events.css">
</head>
<body class="login-page events-page">
  <div class="login-container">
    <div class="events-header">
      <div>
        <h2>Eventos</h2>
        <div class="muted">Gestiona los eventos: crea, edita, elimina y visualiza detalles.</div>
      </div>
      <div>
        <a href="home.html" class="btn">Volver</a>
        <button id="btn-new" class="btn">Nuevo evento</button>
      </div>
    </div>

    <div style="margin:8px 0">
      <input id="search" placeholder="Buscar por nombre, lugar o creador" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e0e0e0">
    </div>

    <div id="events" class="events-list" aria-live="polite">
      <!-- Eventos renderizados aquí -->
    </div>
    <div id="empty" class="muted" style="margin-top:12px;display:none">No hay eventos.</div>
  </div>

  <!-- Modal formulario -->
  <div id="modal" style="display:none" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 id="modal-title">Nuevo evento</h3>
      <form id="event-form">
        <input type="hidden" id="event-id">
        <div class="form-row">
          <label>
            Nombre
            <input id="name" required>
          </label>
          <label>
            Creador
            <input id="creator" placeholder="Usuario que crea el evento" required>
          </label>
        </div>

        <div class="form-row" style="margin-top:8px">
          <label>
            Fecha
            <input id="date" type="date" required>
          </label>
          <label>
            Hora
            <input id="time" type="time" required>
          </label>
        </div>

        <div style="margin-top:8px">
          <label>
            Lugar
            <input id="place" required>
          </label>
        </div>

        <div style="margin-top:8px">
          <label>
            Descripción
            <textarea id="description" rows="4"></textarea>
          </label>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:flex-end">
          <button type="button" id="btn-cancel" class="btn">Cancelar</button>
          <button type="submit" id="btn-save" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Interfaz lista: maneja eventos localmente. Reemplaza los api* por llamadas reales al backend.
    const STORAGE_KEY = 'fallapp_events_v1';

    let events = loadEvents();
    const eventsEl = document.getElementById('events');
    const emptyEl = document.getElementById('empty');

    function loadEvents(){
      try{ const s = localStorage.getItem(STORAGE_KEY); return s? JSON.parse(s): [] }catch(e){return[]}
    }

    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

    function renderList(filter=''){
      eventsEl.innerHTML = '';
      const filtered = events.filter(ev => {
        const q = filter.trim().toLowerCase();
        if(!q) return true;
        return (ev.name||'').toLowerCase().includes(q) || (ev.place||'').toLowerCase().includes(q) || (ev.creator||'').toLowerCase().includes(q);
      });

      if(filtered.length===0){ emptyEl.style.display='block'; return } else { emptyEl.style.display='none' }

      filtered.sort((a,b)=> new Date(a.date + ' ' + (a.time||'00:00')) - new Date(b.date + ' ' + (b.time||'00:00')));

      for(const ev of filtered){
        const card = document.createElement('div'); card.className='event-card';
        const left = document.createElement('div');
        const title = document.createElement('strong'); title.textContent = ev.name || '(sin nombre)';
        const meta = document.createElement('div'); meta.className='event-meta';
        meta.innerHTML = `<span><strong>Creador:</strong> ${escapeHtml(ev.creator||'')}</span> &nbsp;•&nbsp; <span><strong>Fecha:</strong> ${ev.date||''} ${ev.time||''}</span> &nbsp;•&nbsp; <span><strong>Lugar:</strong> ${escapeHtml(ev.place||'')}</span>`;
        const desc = document.createElement('div'); desc.textContent = ev.description || ''; desc.style.marginTop='6px';

        left.appendChild(title); left.appendChild(meta); left.appendChild(desc);

        const actions = document.createElement('div'); actions.className='event-actions';
        const btnView = document.createElement('button'); btnView.className='btn'; btnView.textContent='Ver'; btnView.addEventListener('click', ()=>openView(ev.id));
        const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Editar'; btnEdit.addEventListener('click', ()=>openEdit(ev.id));
        const btnDel = document.createElement('button'); btnDel.className='btn btn-danger'; btnDel.textContent='Eliminar'; btnDel.addEventListener('click', ()=>deleteEvent(ev.id));

        actions.appendChild(btnView); actions.appendChild(btnEdit); actions.appendChild(btnDel);

        card.appendChild(left); card.appendChild(actions);
        eventsEl.appendChild(card);
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Modal & form logic
    const modal = document.getElementById('modal');
    const form = document.getElementById('event-form');
    const inputs = {id:document.getElementById('event-id'),name:document.getElementById('name'),creator:document.getElementById('creator'),date:document.getElementById('date'),time:document.getElementById('time'),place:document.getElementById('place'),description:document.getElementById('description')}

    document.getElementById('btn-new').addEventListener('click', openNew);
    document.getElementById('btn-cancel').addEventListener('click', closeModal);
    document.getElementById('search').addEventListener('input', e=>renderList(e.target.value));
    // Sidebar actions removed; import/export handled by backend when integrated

    function openNew(){
      openModal();
      document.getElementById('modal-title').textContent='Nuevo evento';
      form.reset(); inputs.id.value='';
    }

    function openEdit(id){
      const ev = events.find(x=>x.id===id); if(!ev) return alert('Evento no encontrado');
      openModal(); document.getElementById('modal-title').textContent='Editar evento';
      inputs.id.value = ev.id; inputs.name.value=ev.name||''; inputs.creator.value=ev.creator||''; inputs.date.value=ev.date||''; inputs.time.value=ev.time||''; inputs.place.value=ev.place||''; inputs.description.value=ev.description||'';
    }

    function openView(id){
      const ev = events.find(x=>x.id===id); if(!ev) return alert('Evento no encontrado');
      const text = `Nombre: ${ev.name}\nCreador: ${ev.creator}\nFecha: ${ev.date} ${ev.time||''}\nLugar: ${ev.place}\n\nDescripción:\n${ev.description||''}`;
      alert(text);
    }

    function openModal(){ modal.style.display='flex'; }
    function closeModal(){ modal.style.display='none'; }

    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveFromForm(); });

    function saveFromForm(){
      const id = inputs.id.value;
      const payload = { id: id || generateId(), name: inputs.name.value.trim(), creator: inputs.creator.value.trim(), date: inputs.date.value, time: inputs.time.value, place: inputs.place.value.trim(), description: inputs.description.value.trim() };

      if(id){
        // Aquí irá la llamada a la API para actualizar: await apiUpdateEvent(payload)
        const idx = events.findIndex(x=>x.id===id); if(idx>=0){ events[idx]=payload; }
        saveLocal(); renderList(document.getElementById('search').value);
      } else {
        // Aquí irá la llamada a la API para crear: await apiCreateEvent(payload)
        events.push(payload); saveLocal(); renderList(document.getElementById('search').value);
      }

      closeModal();
    }

    function deleteEvent(id){
      if(!confirm('¿Eliminar este evento?')) return;
      // Aquí irá la llamada a la API para eliminar: await apiDeleteEvent(id)
      events = events.filter(x=>x.id!==id); saveLocal(); renderList(document.getElementById('search').value);
    }

    function generateId(){ return 'ev_' + Math.random().toString(36).slice(2,9); }

    // STUB: funciones para integrar la API. Reemplazar por implementaciones reales.
    async function apiFetchEvents(){ /* return await fetch('/api/events')... */ }
    async function apiCreateEvent(payload){ /* return await fetch('/api/events', {method:'POST',body:JSON.stringify(payload)}) */ }
    async function apiUpdateEvent(payload){ /* return await fetch('/api/events/'+payload.id, {method:'PUT',body:JSON.stringify(payload)}) */ }
    async function apiDeleteEvent(id){ /* return await fetch('/api/events/'+id, {method:'DELETE'}) */ }

    // Render inicial
    renderList();
  </script>
</body>
</html>
