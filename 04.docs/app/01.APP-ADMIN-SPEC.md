# ğŸ› ï¸ FallApp Admin - EspecificaciÃ³n de AplicaciÃ³n

> **Spec ID**: MOBILE-001  
> **VersiÃ³n**: 1.0  
> **Estado**: ğŸ”„ En Desarrollo  
> **Fecha**: 2026-02-01  
> **Package**: `com.fallapp.admin`

---

## ğŸ“‹ Ãndice

1. [Objetivo de la AplicaciÃ³n](#1-objetivo-de-la-aplicaciÃ³n)
2. [Funcionalidades](#2-funcionalidades)
3. [Arquitectura de Features](#3-arquitectura-de-features)
4. [Pantallas y NavegaciÃ³n](#4-pantallas-y-navegaciÃ³n)
5. [Modelos de Dominio](#5-modelos-de-dominio)
6. [API Endpoints Utilizados](#6-api-endpoints-utilizados)
7. [Flujo de AutenticaciÃ³n](#7-flujo-de-autenticaciÃ³n)
8. [Tests de API](#8-tests-de-api)

---

## 1. Objetivo de la AplicaciÃ³n

### 1.1 DescripciÃ³n General

**FallApp Admin** es una aplicaciÃ³n de monitoreo y administraciÃ³n diseÃ±ada exclusivamente para usuarios con rol **ADMIN**. Permite:

- Verificar el estado del servidor en tiempo real
- Ejecutar tests de API desde el mÃ³vil
- Visualizar mÃ©tricas y estadÃ­sticas del sistema
- Gestionar usuarios y permisos rÃ¡pidamente
- Recibir alertas de errores del sistema

### 1.2 Usuarios Objetivo

| Rol | Acceso | Funcionalidades |
|-----|--------|-----------------|
| **ADMIN** | âœ… Completo | Todas las funcionalidades |
| **CASAL** | âŒ Denegado | No puede acceder |
| **USUARIO** | âŒ Denegado | No puede acceder |

### 1.3 Casos de Uso Principales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN USER                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º UC-001: Verificar estado del servidor
         â”‚
         â”œâ”€â”€â–º UC-002: Ejecutar suite de tests API
         â”‚
         â”œâ”€â”€â–º UC-003: Ver mÃ©tricas del sistema
         â”‚
         â”œâ”€â”€â–º UC-004: Consultar logs de errores
         â”‚
         â”œâ”€â”€â–º UC-005: Gestionar usuarios (ban/unban)
         â”‚
         â””â”€â”€â–º UC-006: Recibir notificaciones de alertas
```

---

## 2. Funcionalidades

### 2.1 Feature: Health Monitor

**DescripciÃ³n**: Dashboard en tiempo real del estado del servidor.

| Elemento | DescripciÃ³n |
|----------|-------------|
| **Estado general** | ğŸŸ¢ Online / ğŸ”´ Offline / ğŸŸ¡ Degradado |
| **Latencia** | Tiempo de respuesta promedio (ms) |
| **Ãšltimo check** | Timestamp del Ãºltimo health check |
| **Uptime** | Tiempo desde Ãºltimo reinicio |
| **Auto-refresh** | ActualizaciÃ³n cada 30 segundos |

**Datos a mostrar**:
```kotlin
data class ServerHealth(
    val status: HealthStatus,        // UP, DOWN, DEGRADED
    val responseTimeMs: Long,        // Latencia en milisegundos
    val lastCheck: LocalDateTime,    // Ãšltimo chequeo
    val database: ComponentHealth,   // Estado de PostgreSQL
    val diskSpace: ComponentHealth,  // Espacio en disco
    val memory: ComponentHealth      // Uso de memoria
)

enum class HealthStatus { UP, DOWN, DEGRADED }

data class ComponentHealth(
    val name: String,
    val status: HealthStatus,
    val details: Map<String, String>
)
```

### 2.2 Feature: API Test Suite

**DescripciÃ³n**: Ejecutar tests de API directamente desde el mÃ³vil.

**CategorÃ­as de Tests**:

| CategorÃ­a | Tests | DescripciÃ³n |
|-----------|-------|-------------|
| **Auth** | Login, Registro, Token | AutenticaciÃ³n JWT |
| **Fallas** | CRUD, BÃºsqueda, GeolocalizaciÃ³n | GestiÃ³n de fallas |
| **Eventos** | CRUD, Filtros | GestiÃ³n de eventos |
| **Ninots** | CRUD, VotaciÃ³n | GestiÃ³n de ninots |
| **Votos** | Crear, Consultar | Sistema de votaciÃ³n |

**Estructura de un Test**:
```kotlin
data class ApiTest(
    val id: String,                    // Identificador Ãºnico
    val name: String,                  // "Login con credenciales vÃ¡lidas"
    val category: TestCategory,        // AUTH, FALLAS, EVENTOS, etc.
    val method: HttpMethod,            // GET, POST, PUT, DELETE
    val endpoint: String,              // "/api/auth/login"
    val requestBody: String?,          // JSON del body
    val expectedStatus: Int,           // 200, 201, 401, etc.
    val expectedFields: List<String>,  // Campos esperados en respuesta
    val requiresAuth: Boolean          // Necesita token JWT
)

data class TestResult(
    val test: ApiTest,
    val passed: Boolean,
    val actualStatus: Int,
    val responseTimeMs: Long,
    val responseBody: String?,
    val errorMessage: String?,
    val timestamp: LocalDateTime
)
```

**Suite de Tests Predefinidos**:

```kotlin
val predefinedTests = listOf(
    // Auth Tests
    ApiTest(
        id = "auth-001",
        name = "Login con credenciales vÃ¡lidas",
        category = TestCategory.AUTH,
        method = HttpMethod.POST,
        endpoint = "/api/auth/login",
        requestBody = """{"email":"admin@fallapp.es","contrasena":"Admin123!"}""",
        expectedStatus = 200,
        expectedFields = listOf("exito", "datos.token", "datos.usuario"),
        requiresAuth = false
    ),
    ApiTest(
        id = "auth-002",
        name = "Login con credenciales invÃ¡lidas",
        category = TestCategory.AUTH,
        method = HttpMethod.POST,
        endpoint = "/api/auth/login",
        requestBody = """{"email":"noexiste@test.com","contrasena":"wrongpass"}""",
        expectedStatus = 401,
        expectedFields = listOf("exito", "mensaje"),
        requiresAuth = false
    ),
    
    // Fallas Tests
    ApiTest(
        id = "fallas-001",
        name = "Listar fallas (pÃºblico)",
        category = TestCategory.FALLAS,
        method = HttpMethod.GET,
        endpoint = "/api/fallas?pagina=0&tamano=10",
        requestBody = null,
        expectedStatus = 200,
        expectedFields = listOf("exito", "datos.contenido", "datos.totalElementos"),
        requiresAuth = false
    ),
    ApiTest(
        id = "fallas-002",
        name = "Buscar fallas por texto",
        category = TestCategory.FALLAS,
        method = HttpMethod.GET,
        endpoint = "/api/fallas/buscar?texto=convento",
        requestBody = null,
        expectedStatus = 200,
        expectedFields = listOf("exito", "datos"),
        requiresAuth = false
    ),
    
    // ... mÃ¡s tests
)
```

### 2.3 Feature: MÃ©tricas y EstadÃ­sticas

**DescripciÃ³n**: Dashboard con estadÃ­sticas del sistema.

**MÃ©tricas a mostrar**:
```kotlin
data class SystemMetrics(
    // Contadores
    val totalUsuarios: Int,
    val totalFallas: Int,
    val totalEventos: Int,
    val totalNinots: Int,
    val totalVotos: Int,
    
    // Actividad reciente
    val usuariosActivos24h: Int,
    val votosUltimas24h: Int,
    val eventosProximos7d: Int,
    
    // Rendimiento
    val requestsPerMinute: Double,
    val avgResponseTimeMs: Long,
    val errorRate: Double
)
```

### 2.4 Feature: GestiÃ³n de Usuarios

**DescripciÃ³n**: AdministraciÃ³n rÃ¡pida de usuarios desde el mÃ³vil.

**Acciones disponibles**:
- ğŸ“‹ Listar usuarios con filtros
- ğŸ” Buscar usuario por email
- ğŸš« Banear/Desbanear usuario
- ğŸ‘‘ Cambiar rol (USUARIO â†” CASAL)
- ğŸ—‘ï¸ Eliminar usuario

### 2.5 Feature: Alertas y Notificaciones

**DescripciÃ³n**: Sistema de alertas push para incidencias.

**Tipos de alertas**:
```kotlin
enum class AlertType {
    SERVER_DOWN,        // Servidor caÃ­do
    HIGH_ERROR_RATE,    // Tasa de errores > 5%
    SLOW_RESPONSE,      // Latencia > 3 segundos
    DATABASE_ISSUE,     // Problema con PostgreSQL
    SECURITY_ALERT      // Intento de acceso no autorizado
}

data class Alert(
    val id: String,
    val type: AlertType,
    val severity: Severity,     // LOW, MEDIUM, HIGH, CRITICAL
    val message: String,
    val timestamp: LocalDateTime,
    val acknowledged: Boolean
)
```

---

## 3. Arquitectura de Features

### 3.1 Estructura de Paquetes

```
com.fallapp.admin/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ ApiConfig.kt
â”‚   â”œâ”€â”€ di/
â”‚   â”‚   â””â”€â”€ AdminAppModule.kt
â”‚   â”œâ”€â”€ network/
â”‚   â”‚   â”œâ”€â”€ KtorClient.kt
â”‚   â”‚   â””â”€â”€ AdminAuthInterceptor.kt
â”‚   â””â”€â”€ util/
â”‚       â”œâ”€â”€ Result.kt
â”‚       â””â”€â”€ DateTimeUtils.kt
â”‚
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminAuthApiService.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AdminTokenManager.kt
â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”‚       â””â”€â”€ AdminAuthRepositoryImpl.kt
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AdminUser.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AdminAuthRepository.kt
â”‚   â”‚   â”‚   â””â”€â”€ usecase/
â”‚   â”‚   â”‚       â”œâ”€â”€ AdminLoginUseCase.kt
â”‚   â”‚   â”‚       â””â”€â”€ ValidateAdminRoleUseCase.kt
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â””â”€â”€ login/
â”‚   â”‚           â”œâ”€â”€ AdminLoginScreen.kt
â”‚   â”‚           â”œâ”€â”€ AdminLoginViewModel.kt
â”‚   â”‚           â””â”€â”€ AdminLoginUiState.kt
â”‚   â”‚
â”‚   â”œâ”€â”€ health/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HealthApiService.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ HealthResponseDto.kt
â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”‚       â””â”€â”€ HealthRepositoryImpl.kt
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ServerHealth.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ComponentHealth.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HealthRepository.kt
â”‚   â”‚   â”‚   â””â”€â”€ usecase/
â”‚   â”‚   â”‚       â”œâ”€â”€ GetServerHealthUseCase.kt
â”‚   â”‚   â”‚       â””â”€â”€ StartHealthMonitorUseCase.kt
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â””â”€â”€ dashboard/
â”‚   â”‚           â”œâ”€â”€ HealthDashboardScreen.kt
â”‚   â”‚           â”œâ”€â”€ HealthDashboardViewModel.kt
â”‚   â”‚           â””â”€â”€ components/
â”‚   â”‚               â”œâ”€â”€ ServerStatusCard.kt
â”‚   â”‚               â”œâ”€â”€ LatencyIndicator.kt
â”‚   â”‚               â””â”€â”€ ComponentHealthRow.kt
â”‚   â”‚
â”‚   â”œâ”€â”€ apitests/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TestExecutorService.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TestDefinitionDao.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TestResultDao.kt
â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”‚       â””â”€â”€ ApiTestRepositoryImpl.kt
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ApiTest.kt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TestResult.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TestCategory.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ApiTestRepository.kt
â”‚   â”‚   â”‚   â””â”€â”€ usecase/
â”‚   â”‚   â”‚       â”œâ”€â”€ GetTestsUseCase.kt
â”‚   â”‚   â”‚       â”œâ”€â”€ RunTestUseCase.kt
â”‚   â”‚   â”‚       â”œâ”€â”€ RunTestSuiteUseCase.kt
â”‚   â”‚   â”‚       â””â”€â”€ GetTestHistoryUseCase.kt
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ list/
â”‚   â”‚       â”‚   â”œâ”€â”€ TestListScreen.kt
â”‚   â”‚       â”‚   â””â”€â”€ TestListViewModel.kt
â”‚   â”‚       â”œâ”€â”€ runner/
â”‚   â”‚       â”‚   â”œâ”€â”€ TestRunnerScreen.kt
â”‚   â”‚       â”‚   â””â”€â”€ TestRunnerViewModel.kt
â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚           â”œâ”€â”€ TestCard.kt
â”‚   â”‚           â”œâ”€â”€ TestResultBadge.kt
â”‚   â”‚           â””â”€â”€ TestProgressIndicator.kt
â”‚   â”‚
â”‚   â”œâ”€â”€ metrics/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚
â”‚   â””â”€â”€ users/
â”‚       â”œâ”€â”€ data/
â”‚       â”œâ”€â”€ domain/
â”‚       â””â”€â”€ presentation/
â”‚
â””â”€â”€ navigation/
    â”œâ”€â”€ AdminNavGraph.kt
    â””â”€â”€ AdminRoutes.kt
```

---

## 4. Pantallas y NavegaciÃ³n

### 4.1 Mapa de NavegaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SPLASH SCREEN                                â”‚
â”‚                    (Verificar token + rol ADMIN)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   LOGIN     â”‚             â”‚   MAIN SCREEN   â”‚
           â”‚  (No auth)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚  (Dashboard)    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                           â–¼                       â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  HEALTH MONITOR â”‚         â”‚   API TESTS     â”‚     â”‚    METRICS      â”‚
           â”‚   Dashboard     â”‚         â”‚    Suite        â”‚     â”‚   Dashboard     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚  TEST RUNNER    â”‚
                                       â”‚  (Execution)    â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚  TEST RESULTS   â”‚
                                       â”‚    Detail       â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 DefiniciÃ³n de Rutas

```kotlin
// navigation/AdminRoutes.kt
sealed class AdminRoute(val route: String) {
    data object Splash : AdminRoute("splash")
    data object Login : AdminRoute("login")
    data object Dashboard : AdminRoute("dashboard")
    data object Health : AdminRoute("health")
    data object ApiTests : AdminRoute("api-tests")
    data object TestRunner : AdminRoute("test-runner/{category}") {
        fun createRoute(category: String) = "test-runner/$category"
    }
    data object TestResults : AdminRoute("test-results/{testId}") {
        fun createRoute(testId: String) = "test-results/$testId"
    }
    data object Metrics : AdminRoute("metrics")
    data object Users : AdminRoute("users")
    data object UserDetail : AdminRoute("users/{userId}") {
        fun createRoute(userId: Long) = "users/$userId"
    }
    data object Alerts : AdminRoute("alerts")
    data object Settings : AdminRoute("settings")
}
```

### 4.3 Wireframes de Pantallas

#### 4.3.1 Dashboard Principal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FallApp Admin          [ğŸ‘¤] [âš™ï¸]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸŸ¢ SERVIDOR ONLINE         â”‚   â”‚
â”‚  â”‚  Latencia: 45ms             â”‚   â”‚
â”‚  â”‚  Ãšltimo check: hace 30s     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ§ª TESTS â”‚  â”‚ ğŸ“Š STATS â”‚        â”‚
â”‚  â”‚  12/12 âœ“ â”‚  â”‚  Ver     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ‘¥ USERS â”‚  â”‚ âš ï¸ ALERTSâ”‚        â”‚
â”‚  â”‚  1,234   â”‚  â”‚    0     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚  ACTIVIDAD RECIENTE                 â”‚
â”‚  â”œâ”€ Usuario admin@fallapp.es login â”‚
â”‚  â”œâ”€ Test auth-001 ejecutado âœ“      â”‚
â”‚  â””â”€ Alerta resuelta: slow_response â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ ]    [ğŸ§ª]    [ğŸ“Š]    [ğŸ‘¥]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.2 Pantalla de Tests API

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† API Tests                    [â–¶ï¸]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [ALL] [AUTH] [FALLAS] [EVENTOS]   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ” AUTH TESTS         3/3 âœ“ â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ âœ… Login vÃ¡lido       45ms  â”‚   â”‚
â”‚  â”‚ âœ… Login invÃ¡lido     32ms  â”‚   â”‚
â”‚  â”‚ âœ… Registro nuevo     128ms â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ›ï¸ FALLAS TESTS       5/5 âœ“ â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ âœ… Listar fallas      67ms  â”‚   â”‚
â”‚  â”‚ âœ… Buscar texto       89ms  â”‚   â”‚
â”‚  â”‚ âœ… Falla por ID       34ms  â”‚   â”‚
â”‚  â”‚ âœ… Fallas cercanas    156ms â”‚   â”‚
â”‚  â”‚ âœ… Crear falla        201ms â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“… EVENTOS TESTS      4/4 âœ“ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        [ â–¶ï¸ RUN ALL TESTS ]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Modelos de Dominio

### 5.1 Modelos de Health

```kotlin
// domain/model/ServerHealth.kt
package com.fallapp.admin.features.health.domain.model

data class ServerHealth(
    val status: HealthStatus,
    val responseTimeMs: Long,
    val lastCheck: LocalDateTime,
    val components: List<ComponentHealth>
)

enum class HealthStatus {
    UP,
    DOWN,
    DEGRADED;
    
    fun toEmoji(): String = when (this) {
        UP -> "ğŸŸ¢"
        DOWN -> "ğŸ”´"
        DEGRADED -> "ğŸŸ¡"
    }
}

data class ComponentHealth(
    val name: String,
    val status: HealthStatus,
    val details: Map<String, String> = emptyMap()
)
```

### 5.2 Modelos de Tests

```kotlin
// domain/model/ApiTest.kt
package com.fallapp.admin.features.apitests.domain.model

data class ApiTest(
    val id: String,
    val name: String,
    val description: String,
    val category: TestCategory,
    val method: HttpMethod,
    val endpoint: String,
    val headers: Map<String, String> = emptyMap(),
    val requestBody: String? = null,
    val expectedStatus: Int,
    val expectedFields: List<String> = emptyList(),
    val requiresAuth: Boolean = false,
    val timeout: Long = 30_000L
)

enum class TestCategory {
    AUTH,
    FALLAS,
    EVENTOS,
    NINOTS,
    VOTOS,
    COMENTARIOS,
    ADMIN
}

enum class HttpMethod {
    GET, POST, PUT, DELETE, PATCH
}

// domain/model/TestResult.kt
data class TestResult(
    val testId: String,
    val testName: String,
    val passed: Boolean,
    val actualStatus: Int,
    val expectedStatus: Int,
    val responseTimeMs: Long,
    val responseBody: String?,
    val errorMessage: String?,
    val missingFields: List<String>,
    val timestamp: LocalDateTime
)

data class TestSuiteResult(
    val totalTests: Int,
    val passedTests: Int,
    val failedTests: Int,
    val totalTimeMs: Long,
    val results: List<TestResult>,
    val executedAt: LocalDateTime
)
```

---

## 6. API Endpoints Utilizados

### 6.1 Endpoints de Monitoreo

| MÃ©todo | Endpoint | DescripciÃ³n | Auth |
|--------|----------|-------------|------|
| GET | `/actuator/health` | Estado del servidor | No |
| GET | `/actuator/metrics` | MÃ©tricas del sistema | SÃ­ (ADMIN) |
| GET | `/actuator/info` | InformaciÃ³n de la app | No |

### 6.2 Endpoints de AdministraciÃ³n

| MÃ©todo | Endpoint | DescripciÃ³n | Auth |
|--------|----------|-------------|------|
| GET | `/api/admin/usuarios` | Listar usuarios | SÃ­ (ADMIN) |
| GET | `/api/admin/usuarios/{id}` | Detalle usuario | SÃ­ (ADMIN) |
| PUT | `/api/admin/usuarios/{id}/ban` | Banear usuario | SÃ­ (ADMIN) |
| PUT | `/api/admin/usuarios/{id}/unban` | Desbanear usuario | SÃ­ (ADMIN) |
| PUT | `/api/admin/usuarios/{id}/rol` | Cambiar rol | SÃ­ (ADMIN) |
| DELETE | `/api/admin/usuarios/{id}` | Eliminar usuario | SÃ­ (ADMIN) |
| GET | `/api/admin/stats` | EstadÃ­sticas generales | SÃ­ (ADMIN) |

### 6.3 Endpoints para Tests

Todos los endpoints de la API documentados en [GUIA.API.FRONTEND.md](../../GUIA.API.FRONTEND.md) se utilizan para la ejecuciÃ³n de tests.

---

## 7. Flujo de AutenticaciÃ³n

### 7.1 Login de Admin

```kotlin
// ValidaciÃ³n especial para admin
class AdminLoginUseCase(
    private val authRepository: AdminAuthRepository
) {
    suspend operator fun invoke(
        email: String,
        password: String
    ): Result<AdminUser> {
        // 1. Hacer login normal
        val loginResult = authRepository.login(email, password)
        
        return when (loginResult) {
            is Result.Success -> {
                val user = loginResult.data
                // 2. Verificar que el rol sea ADMIN
                if (user.rol != Rol.ADMIN) {
                    Result.Error(
                        UnauthorizedException("Solo usuarios ADMIN pueden acceder"),
                        "Acceso denegado: Se requiere rol ADMIN"
                    )
                } else {
                    Result.Success(user)
                }
            }
            is Result.Error -> loginResult
            is Result.Loading -> loginResult
        }
    }
}
```

### 7.2 GestiÃ³n de Token

```kotlin
// data/local/AdminTokenManager.kt
class AdminTokenManager(
    private val encryptedPrefs: SharedPreferences
) {
    companion object {
        private const val KEY_TOKEN = "admin_jwt_token"
        private const val KEY_USER = "admin_user"
        private const val KEY_EXPIRATION = "admin_token_expiration"
    }
    
    fun saveToken(token: String, expiresIn: Long) {
        val expiration = System.currentTimeMillis() + (expiresIn * 1000)
        encryptedPrefs.edit()
            .putString(KEY_TOKEN, token)
            .putLong(KEY_EXPIRATION, expiration)
            .apply()
    }
    
    fun getToken(): String? {
        val expiration = encryptedPrefs.getLong(KEY_EXPIRATION, 0)
        if (System.currentTimeMillis() > expiration) {
            clearToken()
            return null
        }
        return encryptedPrefs.getString(KEY_TOKEN, null)
    }
    
    fun isTokenValid(): Boolean = getToken() != null
    
    fun clearToken() {
        encryptedPrefs.edit()
            .remove(KEY_TOKEN)
            .remove(KEY_USER)
            .remove(KEY_EXPIRATION)
            .apply()
    }
}
```

---

## 8. Tests de API

### 8.1 Suite Completa de Tests

```kotlin
// data/local/PredefinedTests.kt
object PredefinedTests {
    
    val authTests = listOf(
        ApiTest(
            id = "auth-001",
            name = "Login con credenciales vÃ¡lidas",
            description = "Verifica que un usuario admin puede hacer login correctamente",
            category = TestCategory.AUTH,
            method = HttpMethod.POST,
            endpoint = "/api/auth/login",
            requestBody = """{"email":"admin@fallapp.es","contrasena":"Admin123!"}""",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos.token", "datos.usuario.rol"),
            requiresAuth = false
        ),
        ApiTest(
            id = "auth-002",
            name = "Login con credenciales invÃ¡lidas",
            description = "Verifica que credenciales incorrectas devuelven 401",
            category = TestCategory.AUTH,
            method = HttpMethod.POST,
            endpoint = "/api/auth/login",
            requestBody = """{"email":"noexiste@test.com","contrasena":"wrongpass"}""",
            expectedStatus = 401,
            expectedFields = listOf("exito", "mensaje"),
            requiresAuth = false
        ),
        ApiTest(
            id = "auth-003",
            name = "Registro de nuevo usuario",
            description = "Verifica el registro de un nuevo usuario",
            category = TestCategory.AUTH,
            method = HttpMethod.POST,
            endpoint = "/api/auth/registro",
            requestBody = """{"email":"test${System.currentTimeMillis()}@test.com","contrasena":"Test123!","nombreCompleto":"Test User"}""",
            expectedStatus = 201,
            expectedFields = listOf("exito", "datos.token", "datos.usuario"),
            requiresAuth = false
        )
    )
    
    val fallasTests = listOf(
        ApiTest(
            id = "fallas-001",
            name = "Listar fallas (pÃºblico)",
            description = "Verifica que el listado de fallas funciona sin autenticaciÃ³n",
            category = TestCategory.FALLAS,
            method = HttpMethod.GET,
            endpoint = "/api/fallas?pagina=0&tamano=10",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos.contenido", "datos.totalElementos", "datos.paginaActual"),
            requiresAuth = false
        ),
        ApiTest(
            id = "fallas-002",
            name = "Buscar fallas por texto",
            description = "Verifica la bÃºsqueda por nombre o descripciÃ³n",
            category = TestCategory.FALLAS,
            method = HttpMethod.GET,
            endpoint = "/api/fallas/buscar?texto=convento",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos"),
            requiresAuth = false
        ),
        ApiTest(
            id = "fallas-003",
            name = "Obtener falla por ID",
            description = "Verifica que se puede obtener una falla especÃ­fica",
            category = TestCategory.FALLAS,
            method = HttpMethod.GET,
            endpoint = "/api/fallas/1",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos.idFalla", "datos.nombre"),
            requiresAuth = false
        ),
        ApiTest(
            id = "fallas-004",
            name = "Fallas cercanas a ubicaciÃ³n",
            description = "Verifica la bÃºsqueda geolocalizada",
            category = TestCategory.FALLAS,
            method = HttpMethod.GET,
            endpoint = "/api/fallas/cercanas?latitud=39.4699&longitud=-0.3763&radio=5.0",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos"),
            requiresAuth = false
        )
    )
    
    val eventosTests = listOf(
        ApiTest(
            id = "eventos-001",
            name = "Listar eventos futuros",
            description = "Verifica que se listan los eventos futuros",
            category = TestCategory.EVENTOS,
            method = HttpMethod.GET,
            endpoint = "/api/eventos/futuros",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos"),
            requiresAuth = false
        ),
        ApiTest(
            id = "eventos-002",
            name = "PrÃ³ximos N eventos",
            description = "Verifica que se obtienen los prÃ³ximos eventos",
            category = TestCategory.EVENTOS,
            method = HttpMethod.GET,
            endpoint = "/api/eventos/proximos?limite=5",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos"),
            requiresAuth = false
        )
    )
    
    val ninotsTests = listOf(
        ApiTest(
            id = "ninots-001",
            name = "Listar ninots",
            description = "Verifica el listado de ninots con paginaciÃ³n",
            category = TestCategory.NINOTS,
            method = HttpMethod.GET,
            endpoint = "/api/ninots?page=0&size=10",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos.content"),
            requiresAuth = false
        ),
        ApiTest(
            id = "ninots-002",
            name = "Ninots premiados",
            description = "Verifica el listado de ninots premiados",
            category = TestCategory.NINOTS,
            method = HttpMethod.GET,
            endpoint = "/api/ninots/premiados",
            expectedStatus = 200,
            expectedFields = listOf("exito", "datos"),
            requiresAuth = false
        )
    )
    
    val allTests: List<ApiTest> = authTests + fallasTests + eventosTests + ninotsTests
}
```

### 8.2 Ejecutor de Tests

```kotlin
// data/remote/TestExecutorService.kt
class TestExecutorService(
    private val httpClient: HttpClient,
    private val tokenManager: AdminTokenManager
) {
    suspend fun executeTest(test: ApiTest): TestResult {
        val startTime = System.currentTimeMillis()
        
        return try {
            val response = httpClient.request(ApiConfig.BASE_URL + test.endpoint) {
                method = when (test.method) {
                    HttpMethod.GET -> io.ktor.http.HttpMethod.Get
                    HttpMethod.POST -> io.ktor.http.HttpMethod.Post
                    HttpMethod.PUT -> io.ktor.http.HttpMethod.Put
                    HttpMethod.DELETE -> io.ktor.http.HttpMethod.Delete
                    HttpMethod.PATCH -> io.ktor.http.HttpMethod.Patch
                }
                
                if (test.requiresAuth) {
                    tokenManager.getToken()?.let { token ->
                        header("Authorization", "Bearer $token")
                    }
                }
                
                test.requestBody?.let { body ->
                    contentType(ContentType.Application.Json)
                    setBody(body)
                }
                
                timeout {
                    requestTimeoutMillis = test.timeout
                }
            }
            
            val responseTimeMs = System.currentTimeMillis() - startTime
            val responseBody = response.bodyAsText()
            
            // Verificar campos esperados
            val missingFields = verifyExpectedFields(responseBody, test.expectedFields)
            
            TestResult(
                testId = test.id,
                testName = test.name,
                passed = response.status.value == test.expectedStatus && missingFields.isEmpty(),
                actualStatus = response.status.value,
                expectedStatus = test.expectedStatus,
                responseTimeMs = responseTimeMs,
                responseBody = responseBody,
                errorMessage = null,
                missingFields = missingFields,
                timestamp = LocalDateTime.now()
            )
        } catch (e: Exception) {
            val responseTimeMs = System.currentTimeMillis() - startTime
            TestResult(
                testId = test.id,
                testName = test.name,
                passed = false,
                actualStatus = -1,
                expectedStatus = test.expectedStatus,
                responseTimeMs = responseTimeMs,
                responseBody = null,
                errorMessage = e.message ?: "Error desconocido",
                missingFields = emptyList(),
                timestamp = LocalDateTime.now()
            )
        }
    }
    
    private fun verifyExpectedFields(json: String, expectedFields: List<String>): List<String> {
        // Implementar verificaciÃ³n de campos usando JsonPath o similar
        // Retorna lista de campos faltantes
        return emptyList() // Placeholder
    }
}
```

---

## ğŸ“š Documentos Relacionados

- [00.ARQUITECTURA-MOBILE.md](00.ARQUITECTURA-MOBILE.md) - Arquitectura general
- [02.APP-USER-SPEC.md](02.APP-USER-SPEC.md) - EspecificaciÃ³n app usuario
- [03.PROMPT-GENERACION-IA.md](03.PROMPT-GENERACION-IA.md) - Prompts para IA
- [../../GUIA.API.FRONTEND.md](../../GUIA.API.FRONTEND.md) - DocumentaciÃ³n API

---

> **Estado de implementaciÃ³n**: ğŸ”„ Pendiente de desarrollo
> **Prioridad**: Alta (herramienta esencial para debugging en producciÃ³n)
