# FallApp - Visión General del Sistema

> **Spec ID**: SPEC-000  
> **Versión**: 1.0  
> **Estado**: ✅ Aprobada  
> **Fecha**: 2026-02-01  
> **Autor**: Equipo FallApp

---

## 1. Resumen Ejecutivo

FallApp es un sistema integral para la gestión y visualización de fallas valencianas, permitiendo:
- **Visualización en mapa** de todas las fallas
- **Gestión de información** por parte de los casales
- **Publicación de eventos** asociados a cada falla
- **Votación individual de ninots** con múltiples categorías (favorito, ingenioso, crítico, artístico)
- **Aplicaciones multiplataforma**: Web (escritorio) + Móvil (Android)

### Principio Rector
> **Funcionalidad completa sobre perfección técnica**: Entregar un sistema funcional end-to-end en 4 semanas.

---

## 2. Contexto del Proyecto

### 2.1 Proyecto Académico
- **Tipo**: Proyecto Intermodular DAM
- **Duración**: 4 semanas (19 enero - 16 febrero 2026)
- **Metodología**: SCRUM adaptado
- **Objetivo**: Sistema completo funcional y desplegado

### 2.2 Módulos Involucrados

| Módulo | Responsabilidad | Tecnología |
|--------|-----------------|------------|
| **ADA** | Backend API + Base de Datos | Spring Boot + PostgreSQL |
| **PMDP** | Aplicación Android | Kotlin + Room + Retrofit |
| **DI** | Aplicación Escritorio | Electron + JavaScript |
| **IPE2** | Modelo de negocio | Canvas + ODS |

---

## 3. Arquitectura General

### 3.1 Diagrama de Componentes

```
┌─────────────────────────────────────────────────────────────┐
│                     CLIENTES                                 │
├──────────────────────────┬──────────────────────────────────┤
│  Aplicación Escritorio   │    Aplicación Móvil Android      │
│       (Electron)         │      (Kotlin + Jetpack)          │
│   - Gestión casales      │    - Visualización mapa          │
│   - Admin dashboard      │    - Votación ninots             │
│                          │    - Consulta eventos            │
└────────────┬─────────────┴────────────┬─────────────────────┘
             │                          │
             │        HTTP/REST         │
             │        JSON              │
             ▼                          ▼
┌────────────────────────────────────────────────────────────┐
│                  API REST (Spring Boot)                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Endpoints:                                          │  │
│  │  - /api/auth        (Autenticación)                  │  │
│  │  - /api/fallas      (Fallas)                         │  │
│  │  - /api/eventos     (Eventos)                        │  │
│  │  - /api/votos       (Votaciones)                     │  │
│  │  - /api/usuarios    (Usuarios)                       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Servicios (Lógica de Negocio)                       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Repositorios (Spring Data JPA)                      │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬───────────────────────────────────┘
                         │
                         ▼
             ┌───────────────────────┐
             │   PostgreSQL 15       │
             │   Base de Datos       │
             └───────────────────────┘
```

### 3.2 Stack Tecnológico

#### Backend
- **Framework**: Spring Boot 3.2+
- **Lenguaje**: Java 17
- **Base de Datos**: PostgreSQL 15
- **ORM**: Spring Data JPA + Hibernate
- **Seguridad**: Spring Security + JWT
- **Migraciones**: Flyway
- **Documentación API**: Springdoc OpenAPI 3.0

#### Frontend Escritorio (Electron)
- **Framework**: Electron 28+
- **UI**: HTML5 + CSS3 + JavaScript ES6+
- **Comunicación API**: Fetch API
- **Almacenamiento**: electron-store

#### Móvil (Android)
- **Lenguaje**: Kotlin 1.9+
- **Arquitectura**: Clean Architecture + MVI
- **UI**: Jetpack Compose / XML Layouts
- **Base de Datos Local**: Room
- **Networking**: Retrofit 2 + Ktor
- **Mapas**: Google Maps SDK
- **Inyección de Dependencias**: Koin / Hilt

#### Infraestructura
- **Contenedores**: Docker + Docker Compose
- **Servidor**: AWS EC2 (t2.medium o similar)
- **Proxy Inverso**: Nginx
- **SSL**: Let's Encrypt (Certbot)

---

## 4. Modelo de Dominio

### 4.1 Entidades Principales

```
┌──────────────┐
│   Usuario    │
└──────┬───────┘
       │ 1
       │
       │ n
┌──────▼───────┐       1       ┌────────────┐
│    Falla     ├────────────────┤  Evento    │
│   (Casal)    │                └────────────┘
└──────┬───────┘
       │ 1
       │
       │ n
┌──────▼───────┐       n       ┌────────────┐
│    Ninot     ├────────────────┤    Voto    │
└──────────────┘                └────────────┘
```

### 4.2 Descripciones de Entidades

#### Usuario
Persona que usa el sistema con diferentes roles.

**Atributos principales**:
- ID, email, contraseña (hash), nombre, apellidos
- Rol: `ADMIN`, `CASAL`, `USUARIO`
- Fecha de registro

#### Falla (Casal)
Comisión fallera con su información y ubicación.

**Atributos principales**:
- ID, nombre, dirección, coordenadas (lat/lng)
- Descripción, año de fundación
- Usuario responsable (casal)

#### Evento
Actividad organizada por una falla.

**Atributos principales**:
- ID, título, descripción
- Fecha y hora
- Falla organizadora
- Imagen (URL)

#### Ninot
Figura de falla que puede ser votada.

**Atributos principales**:
- ID, nombre, descripción
- Falla a la que pertenece
- Imagen (URL)

#### Voto
Voto de un usuario a un ninot específico.

**Atributos principales**:
- ID, usuario, ninot
- Fecha del voto
- **Restricción**: Un usuario solo puede votar una vez por ninot

---

## 5. Roles y Permisos

### 5.1 Roles del Sistema

| Rol | Código | Descripción |
|-----|--------|-------------|
| **Administrador** | `ADMIN` | Control total del sistema |
| **Casal** | `CASAL` | Gestiona su falla y eventos |
| **Usuario** | `USUARIO` | Visualiza y vota |

### 5.2 Matriz de Permisos

| Funcionalidad | ADMIN | CASAL | USUARIO |
|---------------|-------|-------|---------|
| Ver fallas | ✅ | ✅ | ✅ |
| Crear falla | ✅ | ❌ | ❌ |
| Editar propia falla | ✅ | ✅ | ❌ |
| Editar cualquier falla | ✅ | ❌ | ❌ |
| Ver eventos | ✅ | ✅ | ✅ |
| Crear evento (propia falla) | ✅ | ✅ | ❌ |
| Editar evento (propia falla) | ✅ | ✅ | ❌ |
| Ver ninots | ✅ | ✅ | ✅ |
| Votar ninots | ✅ | ✅ | ✅ |
| Ver resultados votación | ✅ | ✅ | ❌ |
| Gestionar usuarios | ✅ | ❌ | ❌ |

---

## 6. Casos de Uso Principales

### 6.1 Usuario Regular (Móvil)

#### CU-01: Visualizar Fallas en Mapa
1. Usuario abre la app móvil
2. Se muestra mapa con marcadores de todas las fallas
3. Usuario hace clic en un marcador
4. Se muestra información de la falla (nombre, dirección, eventos)

#### CU-02: Votar un Ninot
1. Usuario navega a la lista de ninots
2. Selecciona un ninot
3. Presiona "Votar"
4. Sistema verifica que no haya votado previamente
5. Se registra el voto
6. Mensaje de confirmación

#### CU-03: Consultar Eventos
1. Usuario accede a sección de eventos
2. Sistema muestra lista de eventos próximos
3. Puede filtrar por falla
4. Al seleccionar, ve detalles del evento

### 6.2 Casal (Escritorio)

#### CU-04: Gestionar Información de Falla
1. Casal inicia sesión en aplicación escritorio
2. Accede a "Mi Falla"
3. Edita información (nombre, dirección, descripción)
4. Actualiza coordenadas en mapa
5. Guarda cambios
6. Sistema valida y confirma actualización

#### CU-05: Crear Evento
1. Casal accede a "Eventos"
2. Hace clic en "Nuevo Evento"
3. Rellena formulario (título, descripción, fecha, hora)
4. Opcionalmente sube imagen
5. Guarda evento
6. Sistema valida y publica el evento

#### CU-06: Gestionar Ninots
1. Casal accede a "Ninots"
2. Puede crear, editar o eliminar ninots de su falla
3. Sube imágenes de los ninots
4. Activa/desactiva votación

### 6.3 Administrador (Escritorio)

#### CU-07: Gestionar Fallas
1. Admin accede al panel de administración
2. Ve lista de todas las fallas
3. Puede crear, editar o eliminar cualquier falla
4. Puede asignar/cambiar usuario responsable (casal)

#### CU-08: Gestionar Usuarios
1. Admin accede a "Usuarios"
2. Ve lista de todos los usuarios
3. Puede crear, editar o desactivar usuarios
4. Puede cambiar roles

#### CU-09: Ver Estadísticas
1. Admin accede a "Dashboard"
2. Ve estadísticas generales:
   - Total de fallas registradas
   - Total de eventos publicados
   - Total de votos emitidos
   - Usuarios registrados por rol

---

## 7. Flujos de Autenticación

### 7.1 Registro de Usuario

```
Usuario → Frontend → API
         [POST /api/auth/registrar]
         {
           "email": "usuario@example.com",
           "password": "contraseña",
           "nombre": "Juan",
           "apellidos": "García"
         }
         
         ← [201 Created]
         {
           "id": 123,
           "email": "usuario@example.com",
           "nombre": "Juan",
           "rol": "USUARIO"
         }
```

### 7.2 Inicio de Sesión

```
Usuario → Frontend → API
         [POST /api/auth/login]
         {
           "email": "usuario@example.com",
           "password": "contraseña"
         }
         
         ← [200 OK]
         {
           "token": "eyJhbGciOiJIUzI1NiIs...",
           "usuario": {
             "id": 123,
             "email": "usuario@example.com",
             "nombre": "Juan",
             "rol": "USUARIO"
           }
         }
```

### 7.3 Petición Autenticada

```
Frontend → API
         [GET /api/eventos]
         Headers: {
           "Authorization": "Bearer eyJhbGciOiJIUzI1NiIs..."
         }
         
         ← [200 OK]
         [... lista de eventos ...]
```

---

## 8. Estrategia de Datos

### 8.1 Almacenamiento

| Tipo de Dato | Ubicación | Estrategia |
|--------------|-----------|------------|
| Datos estructurados | PostgreSQL | Normalizado, con índices |
| Imágenes | Sistema de archivos | Ruta almacenada en BD |
| Tokens JWT | Cliente (memoria/storage) | No persistir contraseñas |
| Caché móvil | Room (SQLite) | Offline-first |

### 8.2 Backup

- **Frecuencia**: Diaria automática (PostgreSQL)
- **Retención**: 7 días
- **Ubicación**: Volumen Docker separado + S3 (opcional)

---

## 9. Requisitos No Funcionales

### 9.1 Rendimiento
- ✅ API responde en <500ms para consultas simples
- ✅ Mapa carga marcadores en <2s con 100+ fallas
- ✅ Aplicación móvil funciona offline (datos cacheados)

### 9.2 Seguridad
- ✅ Contraseñas hasheadas con BCrypt
- ✅ HTTPS obligatorio en producción
- ✅ Tokens JWT con expiración (24h)
- ✅ Validación de entrada en API
- ✅ Protección CORS configurada

### 9.3 Escalabilidad
- ✅ Soportar 1000+ usuarios concurrentes (fase inicial)
- ✅ Almacenar 500+ fallas
- ✅ 10,000+ votos

### 9.4 Disponibilidad
- ✅ Objetivo: 99% uptime (permite ~7h downtime/mes)
- ✅ Recuperación ante fallos: <30 minutos

---

## 10. Fases de Implementación

### Fase 1: Fundamentos (Semana 1)
- ✅ Configuración del entorno (Docker, PostgreSQL)
- ✅ Backend básico: Usuarios, Autenticación
- ✅ Migraciones de base de datos
- ✅ Aplicación Electron: Login y estructura

### Fase 2: Funcionalidad Core (Semana 2)
- ✅ Backend: Fallas, Eventos, Ninots
- ✅ Electron: CRUD fallas y eventos
- ✅ Android: Estructura básica + API client

### Fase 3: Integración (Semana 3)
- ✅ Android: Mapa con fallas
- ✅ Android: Sistema de votación
- ✅ Electron: Panel de administración
- ✅ Pruebas de integración

### Fase 4: Pulido y Despliegue (Semana 4)
- ✅ Pruebas completas (~100 tests)
- ✅ Despliegue en AWS EC2
- ✅ Documentación final
- ✅ Preparación de presentación

---

## 11. Dependencias Externas

### 11.1 APIs y Servicios

| Servicio | Propósito | Coste | Alternativa |
|----------|-----------|-------|-------------|
| Google Maps API | Mapas en Android | Gratis (hasta límite) | OpenStreetMap |
| AWS EC2 | Hosting backend | ~20€/mes | Servidor local |

### 11.2 Librerías Principales

**Backend (Maven)**:
```xml
- spring-boot-starter-web
- spring-boot-starter-data-jpa
- spring-boot-starter-security
- postgresql
- jjwt (JWT)
- springdoc-openapi (documentación)
- flyway-core (migraciones)
```

**Android (Gradle)**:
```gradle
- androidx.compose:compose-bom
- retrofit2:retrofit
- room:room-runtime
- play-services-maps
- coil-compose (imágenes)
```

---

## 12. Métricas de Éxito

### 12.1 Técnicas
- ✅ 100% funcionalidades especificadas implementadas
- ✅ >80% cobertura de pruebas en API
- ✅ 0 errores críticos en producción
- ✅ API documentada con OpenAPI

### 12.2 Académicas
- ✅ Memoria completa (~15 páginas)
- ✅ Presentación preparada (15 min)
- ✅ Demo funcional end-to-end
- ✅ Código en repositorio Git

---

## 13. Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigación |
|--------|--------------|---------|------------|
| Retraso en implementación | Alta | Alto | Priorizar funcionalidad mínima viable |
| Problemas con API Google Maps | Media | Medio | Preparar fallback con OpenStreetMap |
| Bugs críticos pre-presentación | Media | Alto | Testing continuo + semana de buffer |
| Sobrecarga del servidor AWS | Baja | Medio | Monitorización + escalado vertical |

---

## 14. Contacto y Referencias

### Repositorio
- **GitHub**: [enlace al repositorio]

### Documentación Adicional
- [01.SISTEMA-USUARIOS.md](01.SISTEMA-USUARIOS.md) - Sistema de usuarios y autenticación
- [02.FALLAS.md](02.FALLAS.md) - Gestión de fallas
- [03.EVENTOS.md](03.EVENTOS.md) - Sistema de eventos
- [04.VOTACIONES.md](04.VOTACIONES.md) - Sistema de votación

### Equipo
- [Lista de miembros del equipo]

---

> **Nota**: Este documento es la piedra angular del proyecto. Léelo completamente antes de empezar cualquier implementación.
