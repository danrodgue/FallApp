# Sistema de VotaciÃ³n de Ninots

> **Spec ID**: SPEC-VOTOS-001  
> **VersiÃ³n**: 2.0  
> **Estado**: âœ… Implementado  
> **Fecha**: 2026-02-03  
> **Autor**: Equipo FallApp

---

## 1. Resumen Ejecutivo

El sistema de votaciÃ³n permite a los usuarios **votar ninots individuales** en diferentes categorÃ­as, generando rankings comunitarios y estadÃ­sticas por tipo de voto.

### Cambio Importante (v2.0)

**DISEÃ‘O ORIGINAL (v1.0 - No implementado)**:
- Votos a **fallas completas**
- Tipos: `me_gusta`, `mejor_ninot`, `mejor_tema`
- RestricciÃ³n: 1 voto por tipo por falla

**IMPLEMENTACIÃ“N ACTUAL (v2.0)**:
- Votos a **ninots individuales**
- Tipos: `favorito`, `ingenioso`, `critico`, `artistico`, `rating`
- RestricciÃ³n: 1 voto por tipo por ninot
- Permite mÃºltiples votos a ninots de la misma falla

---

## 2. Modelo de Datos

### 2.1 Tabla: votos

```sql
CREATE TABLE votos (
    id_voto SERIAL PRIMARY KEY,
    id_usuario INTEGER NOT NULL REFERENCES usuarios(id_usuario) ON DELETE CASCADE,
    id_ninot INTEGER NOT NULL REFERENCES ninots(id_ninot) ON DELETE CASCADE,
    tipo_voto tipo_voto NOT NULL,
    fecha_creacion TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    actualizado TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT uk_usuario_ninot_tipo 
        UNIQUE (id_usuario, id_ninot, tipo_voto)
);

CREATE TYPE tipo_voto AS ENUM (
    'favorito',
    'ingenioso',
    'critico',
    'artistico',
    'rating'
);
```

### 2.2 Ãndices

```sql
CREATE INDEX idx_votos_id_usuario ON votos(id_usuario);
CREATE INDEX idx_votos_id_ninot ON votos(id_ninot);
CREATE INDEX idx_votos_tipo_voto ON votos(tipo_voto);
CREATE INDEX idx_votos_fecha_creacion ON votos(fecha_creacion);
```

### 2.3 Constraint Ãšnico

**RestricciÃ³n**: Un usuario puede votar **una sola vez por tipo por ninot**.

```sql
CONSTRAINT uk_usuario_ninot_tipo 
    UNIQUE (id_usuario, id_ninot, tipo_voto)
```

**Ejemplos**:
- âœ… Usuario 1 â†’ Ninot 5 â†’ Tipo `favorito` (OK)
- âœ… Usuario 1 â†’ Ninot 5 â†’ Tipo `ingenioso` (OK, diferente tipo)
- âœ… Usuario 1 â†’ Ninot 8 â†’ Tipo `favorito` (OK, diferente ninot)
- âŒ Usuario 1 â†’ Ninot 5 â†’ Tipo `favorito` (ERROR: voto duplicado)

---

## 3. Tipos de Voto

| Tipo | CÃ³digo | DescripciÃ³n | Uso |
|------|--------|-------------|-----|
| **Favorito** | `favorito` | Voto general al ninot preferido | Ranking popular |
| **Ingenioso** | `ingenioso` | Ninot mÃ¡s ingenioso/creativo | Originalidad |
| **CrÃ­tico** | `critico` | Mejor crÃ­tica social/satÃ­rica | Mensaje social |
| **ArtÃ­stico** | `artistico` | Mejor calidad artÃ­stica | TÃ©cnica y ejecuciÃ³n |
| **Rating** | `rating` | ValoraciÃ³n 1-5 estrellas | **NO IMPLEMENTADO** |

### 3.1 PropÃ³sito de Cada Tipo

#### Favorito
- Voto mÃ¡s general y popular
- Refleja preferencia personal del usuario
- Usado para ranking principal de ninots

#### Ingenioso
- Valora creatividad y originalidad
- Premios a ideas innovadoras
- Fomenta diseÃ±os Ãºnicos

#### CrÃ­tico
- Voto a mejor crÃ­tica social o sÃ¡tira polÃ­tica
- Refleja la tradiciÃ³n fallera de crÃ­tica
- Ranking de ninots con mensaje

#### ArtÃ­stico
- Valora tÃ©cnica, materiales, ejecuciÃ³n
- Juicio sobre calidad constructiva
- Reconoce trabajo artesanal

#### Rating (Pendiente)
- Sistema de estrellas 1-5
- ValoraciÃ³n numÃ©rica general
- Futuro: promedio de ratings por ninot

---

## 4. API REST

### 4.1 POST /api/votos - Registrar Voto

**AutenticaciÃ³n**: Requerida (JWT)

**Request Body**:
```json
{
  "idNinot": 15,
  "tipoVoto": "favorito"
}
```

**Response 201 Created**:
```json
{
  "success": true,
  "message": "Voto registrado exitosamente",
  "data": {
    "idVoto": 342,
    "idUsuario": 5,
    "idNinot": 15,
    "nombreNinot": "El PolÃ­tico",
    "tipoVoto": "favorito",
    "fechaCreacion": "2026-02-03T10:45:30Z"
  },
  "timestamp": "2026-02-03T10:45:30Z"
}
```

**Response 409 Conflict** (voto duplicado):
```json
{
  "success": false,
  "error": "VOTO_DUPLICADO",
  "message": "Ya has votado este ninot con tipo 'favorito'",
  "timestamp": "2026-02-03T10:45:30Z"
}
```

**Validaciones**:
1. Usuario debe estar autenticado
2. `idNinot` debe existir en la base de datos
3. `tipoVoto` debe ser uno de los valores vÃ¡lidos del enum
4. No debe existir un voto previo del mismo usuario, ninot y tipo

### 4.2 GET /api/votos/usuario/{idUsuario} - Votos del Usuario

**AutenticaciÃ³n**: Requerida (JWT)

**Permisos**:
- Usuario solo puede ver sus propios votos
- ADMIN puede ver votos de cualquier usuario

**Response 200 OK**:
```json
{
  "success": true,
  "data": [
    {
      "idVoto": 342,
      "idNinot": 15,
      "nombreNinot": "El PolÃ­tico",
      "tituloObra": "Promesas VacÃ­as",
      "idFalla": 3,
      "nombreFalla": "Falla Plaza del Ayuntamiento",
      "tipoVoto": "favorito",
      "fechaCreacion": "2026-02-03T10:45:30Z"
    },
    {
      "idVoto": 343,
      "idNinot": 15,
      "nombreNinot": "El PolÃ­tico",
      "tituloObra": "Promesas VacÃ­as",
      "idFalla": 3,
      "nombreFalla": "Falla Plaza del Ayuntamiento",
      "tipoVoto": "ingenioso",
      "fechaCreacion": "2026-02-03T11:20:15Z"
    }
  ]
}
```

### 4.3 GET /api/votos/ninot/{idNinot} - Votos de un Ninot

**AutenticaciÃ³n**: No requerida (pÃºblico)

**Query Parameters**:
- `tipo` (opcional): Filtrar por tipo de voto

**Response 200 OK**:
```json
{
  "success": true,
  "data": {
    "idNinot": 15,
    "nombreNinot": "El PolÃ­tico",
    "estadisticas": {
      "totalVotos": 428,
      "votosFavorito": 156,
      "votosIngenioso": 98,
      "votosCritico": 124,
      "votosArtistico": 50
    },
    "votos": [
      {
        "idVoto": 342,
        "tipoVoto": "favorito",
        "fechaCreacion": "2026-02-03T10:45:30Z"
      }
    ]
  }
}
```

### 4.4 DELETE /api/votos/{idVoto} - Eliminar Voto

**AutenticaciÃ³n**: Requerida (JWT)

**Permisos**:
- Usuario solo puede eliminar sus propios votos
- ADMIN puede eliminar cualquier voto

**Response 200 OK**:
```json
{
  "success": true,
  "message": "Voto eliminado",
  "timestamp": "2026-02-03T11:30:00Z"
}
```

---

## 5. LÃ³gica de Negocio

### 5.1 Flujo de VotaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Usuario autenticado selecciona ninot         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Elige tipo de voto (favorito/ingenioso/etc)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Backend valida:                               â”‚
â”‚    - Usuario autenticado (JWT)                   â”‚
â”‚    - Ninot existe                                â”‚
â”‚    - Tipo vÃ¡lido                                 â”‚
â”‚    - No voto duplicado (UK constraint)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰XITO         â”‚   â”‚ ERROR 409    â”‚
â”‚ Voto guardado â”‚   â”‚ Duplicado    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Actualizar estadÃ­sticas en cache (Room)      â”‚
â”‚    - totalVotos++                                â”‚
â”‚    - votosFavorito++ (segÃºn tipo)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Reglas de ValidaciÃ³n

| ValidaciÃ³n | DescripciÃ³n | HTTP Status |
|------------|-------------|-------------|
| **AutenticaciÃ³n** | JWT vÃ¡lido en header `Authorization` | 401 Unauthorized |
| **Ninot existe** | `idNinot` debe existir en tabla `ninots` | 404 Not Found |
| **Tipo vÃ¡lido** | Debe ser uno de los 5 valores del enum | 400 Bad Request |
| **Voto Ãºnico** | UK constraint `(id_usuario, id_ninot, tipo_voto)` | 409 Conflict |

### 5.3 Casos Especiales

#### Usuario vota mÃºltiples tipos al mismo ninot
âœ… **Permitido** - Puede votar los 4 tipos (favorito, ingenioso, critico, artistico)

```
Usuario 1 â†’ Ninot 5:
  - favorito âœ…
  - ingenioso âœ…
  - critico âœ…
  - artistico âœ…
```

#### Usuario cambia de opiniÃ³n
âŒ **No permitido** - Debe eliminar el voto existente primero

Flujo:
1. `DELETE /api/votos/{idVoto}` (eliminar voto anterior)
2. `POST /api/votos` (crear nuevo voto)

#### VotaciÃ³n anÃ³nima
âŒ **No permitido** - Requiere autenticaciÃ³n para trazabilidad

---

## 6. Rankings y EstadÃ­sticas

### 6.1 Ranking de Ninots por Tipo

**Endpoint**: `GET /api/ninots/premiados?tipo={tipoVoto}&limite=10`

**Query con ordenaciÃ³n**:
```sql
SELECT 
    n.id_ninot,
    n.nombre_ninot,
    n.titulo_obra,
    f.nombre_falla,
    COUNT(v.id_voto) as total_votos
FROM ninots n
INNER JOIN fallas f ON n.id_falla = f.id_falla
LEFT JOIN votos v ON n.id_ninot = v.id_ninot 
    AND v.tipo_voto = 'favorito'  -- Filtro por tipo
GROUP BY n.id_ninot, n.nombre_ninot, n.titulo_obra, f.nombre_falla
ORDER BY total_votos DESC
LIMIT 10;
```

### 6.2 Vista Agregada de EstadÃ­sticas

```sql
CREATE VIEW v_ninots_estadisticas AS
SELECT 
    n.id_ninot,
    n.nombre_ninot,
    n.titulo_obra,
    COUNT(v.id_voto) as total_votos,
    COUNT(CASE WHEN v.tipo_voto = 'favorito' THEN 1 END) as votos_favorito,
    COUNT(CASE WHEN v.tipo_voto = 'ingenioso' THEN 1 END) as votos_ingenioso,
    COUNT(CASE WHEN v.tipo_voto = 'critico' THEN 1 END) as votos_critico,
    COUNT(CASE WHEN v.tipo_voto = 'artistico' THEN 1 END) as votos_artistico
FROM ninots n
LEFT JOIN votos v ON n.id_ninot = v.id_ninot
GROUP BY n.id_ninot, n.nombre_ninot, n.titulo_obra;
```

---

## 7. ImplementaciÃ³n MÃ³vil (Android)

### 7.1 Modelo Domain
```kotlin
enum class TipoVoto {
    FAVORITO,
    INGENIOSO,
    CRITICO,
    ARTISTICO
}

data class Voto(
    val idVoto: Long,
    val idNinot: Long,
    val tipoVoto: TipoVoto,
    val fechaCreacion: LocalDateTime
)
```

### 7.2 Use Case
```kotlin
class VotarNinotUseCase(
    private val repository: NinotsRepository
) {
    suspend operator fun invoke(
        idNinot: Long,
        tipoVoto: TipoVoto
    ): Result<Voto> {
        return repository.votarNinot(idNinot, tipoVoto)
    }
}
```

### 7.3 UI - DiÃ¡logo de VotaciÃ³n

```kotlin
@Composable
fun VoteDialog(
    ninot: Ninot,
    onDismiss: () -> Unit,
    onVote: (TipoVoto) -> Unit
) {
    AlertDialog(
        title = { Text("Votar \"${ninot.nombreNinot}\"") },
        text = {
            Column {
                VoteButton(TipoVoto.FAVORITO, "â­ Favorito")
                VoteButton(TipoVoto.INGENIOSO, "ğŸ’¡ Ingenioso")
                VoteButton(TipoVoto.CRITICO, "ğŸ­ CrÃ­tico")
                VoteButton(TipoVoto.ARTISTICO, "ğŸ¨ ArtÃ­stico")
            }
        }
    )
}
```

---

## 8. Testing

### 8.1 Unit Tests

```kotlin
class VotarNinotUseCaseTest {
    @Test
    fun `votar con ID invalido retorna error`() {
        // Given
        val useCase = VotarNinotUseCase(repository)
        
        // When
        val result = runBlocking { 
            useCase(idNinot = -1, TipoVoto.FAVORITO) 
        }
        
        // Then
        assertTrue(result is Result.Error)
    }
    
    @Test
    fun `votar con exito retorna voto`() {
        // Given
        val idNinot = 5L
        val expected = Voto(1, idNinot, TipoVoto.FAVORITO, LocalDateTime.now())
        coEvery { repository.votarNinot(any(), any()) } returns Result.Success(expected)
        
        // When
        val result = runBlocking { useCase(idNinot, TipoVoto.FAVORITO) }
        
        // Then
        assertTrue(result is Result.Success)
        assertEquals(expected, (result as Result.Success).data)
    }
}
```

### 8.2 Integration Tests

```sql
-- Test: Constraint de voto Ãºnico
BEGIN;
    INSERT INTO votos (id_usuario, id_ninot, tipo_voto) 
    VALUES (1, 5, 'favorito');
    
    -- Debe fallar con error de constraint Ãºnico
    INSERT INTO votos (id_usuario, id_ninot, tipo_voto) 
    VALUES (1, 5, 'favorito');
ROLLBACK;

-- Test: Usuario puede votar mÃºltiples tipos al mismo ninot
BEGIN;
    INSERT INTO votos (id_usuario, id_ninot, tipo_voto) 
    VALUES (1, 5, 'favorito');
    
    INSERT INTO votos (id_usuario, id_ninot, tipo_voto) 
    VALUES (1, 5, 'ingenioso');
    
    -- Ambos deben existir
    SELECT COUNT(*) FROM votos WHERE id_usuario = 1 AND id_ninot = 5;
    -- Resultado: 2
ROLLBACK;
```

---

## 9. MÃ©tricas y KPIs

### 9.1 MÃ©tricas de ParticipaciÃ³n

- **Total votos**: Suma de todos los votos registrados
- **Usuarios activos**: Usuarios que han votado al menos 1 vez
- **Tasa de participaciÃ³n**: `usuarios_que_votan / total_usuarios`
- **Votos por usuario**: Promedio de votos por usuario activo

### 9.2 MÃ©tricas por Tipo

- **DistribuciÃ³n de votos**: % de cada tipo sobre total
- **Tipo mÃ¡s popular**: Tipo con mayor cantidad de votos
- **Ninots mÃ¡s votados**: Top 10 por cada tipo

### 9.3 Consultas de MÃ©tricas

```sql
-- Total votos y usuarios activos
SELECT 
    COUNT(*) as total_votos,
    COUNT(DISTINCT id_usuario) as usuarios_activos
FROM votos;

-- DistribuciÃ³n por tipo
SELECT 
    tipo_voto,
    COUNT(*) as total,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as porcentaje
FROM votos
GROUP BY tipo_voto
ORDER BY total DESC;

-- Top 10 ninots mÃ¡s votados (favorito)
SELECT 
    n.nombre_ninot,
    f.nombre_falla,
    COUNT(v.id_voto) as votos
FROM ninots n
INNER JOIN fallas f ON n.id_falla = f.id_falla
INNER JOIN votos v ON n.id_ninot = v.id_ninot
WHERE v.tipo_voto = 'favorito'
GROUP BY n.id_ninot, n.nombre_ninot, f.nombre_falla
ORDER BY votos DESC
LIMIT 10;
```

---

## 10. Roadmap Futuro

### v2.1 (PrÃ³ximo)
- [ ] Implementar sistema de `rating` (1-5 estrellas)
- [ ] Agregar comentarios a votos
- [ ] Notificaciones push cuando ninot votado gana premio

### v2.2
- [ ] Sistema de "votos destacados" (usuarios influyentes)
- [ ] Badges/insignias por actividad de votaciÃ³n
- [ ] Timeline de votos en perfil de usuario

### v3.0
- [ ] Machine Learning: Recomendaciones de ninots basadas en votos previos
- [ ] PredicciÃ³n de ganadores
- [ ] AnÃ¡lisis de sentimiento en comentarios

---

## 11. Referencias

- **CÃ³digo Backend**: `/01.backend/src/main/java/com/fallapp/model/Voto.java`
- **Controlador**: `/01.backend/src/main/java/com/fallapp/controller/VotoController.java`
- **Schema SQL**: `/07.datos/scripts/01.schema.sql` (tabla votos)
- **API Docs**: `/01.backend/README_API.md` (endpoints de votos)
- **Spec Base de Datos**: `/04.docs/especificaciones/03.BASE-DATOS.md`

---

**Ãšltima actualizaciÃ³n**: 2026-02-03  
**Autor**: Equipo FallApp  
**Revisores**: @gauti
