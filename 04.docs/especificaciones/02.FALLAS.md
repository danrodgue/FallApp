# Sistema de Gestión de Fallas (Casales)

> **Spec ID**: SPEC-002  
> **Versión**: 1.0  
> **Estado**: ✅ Aprobada  
> **Fecha**: 2026-02-01

---

## 1. Resumen

Sistema para gestionar la información de las fallas/casales valencianos, incluyendo:
- **Ubicación geográfica GPS** (253 fallas con coordenadas - 72.9% cobertura)
- Información básica (nombre, sección, fundación, distintivos)
- Datos de representantes (presidente, fallera)
- Obras artísticas (lema, artista, boceto)
- Asociación con usuarios responsables

---

## 2. Modelo de Datos

### 2.1 Tabla SQL

```sql
CREATE TABLE fallas (
    id BIGSERIAL PRIMARY KEY,
    nombre VARCHAR(200) NOT NULL,
    direccion VARCHAR(300) NOT NULL,
    latitud DECIMAL(10, 8) NOT NULL,
    longitud DECIMAL(11, 8) NOT NULL,
    descripcion TEXT,
    ano_fundacion INTEGER,
    usuario_responsable_id BIGINT,
    imagen_url VARCHAR(500),
    activa BOOLEAN DEFAULT true,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_usuario_responsable FOREIGN KEY (usuario_responsable_id) 
        REFERENCES usuarios(id) ON DELETE SET NULL,
    CONSTRAINT check_latitud CHECK (latitud BETWEEN -90 AND 90),
    CONSTRAINT check_longitud CHECK (longitud BETWEEN -180 AND 180)
);

CREATE INDEX idx_fallas_usuario ON fallas(usuario_responsable_id);
CREATE INDEX idx_fallas_ubicacion ON fallas(latitud, longitud);
CREATE INDEX idx_fallas_activa ON fallas(activa);
```

### 2.2 Entidad JPA

```java
@Entity
@Table(name = "fallas")
public class Falla {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 200)
    @NotBlank(message = "Nombre es obligatorio")
    private String nombre;
    
    @Column(nullable = false, length = 300)
    @NotBlank(message = "Dirección es obligatoria")
    private String direccion;
    
    @Column(nullable = false, precision = 10, scale = 8)
    @DecimalMin(value = "-90.0", message = "Latitud debe estar entre -90 y 90")
    @DecimalMax(value = "90.0", message = "Latitud debe estar entre -90 y 90")
    private BigDecimal latitud;
    
    @Column(nullable = false, precision = 11, scale = 8)
    @DecimalMin(value = "-180.0", message = "Longitud debe estar entre -180 y 180")
    @DecimalMax(value = "180.0", message = "Longitud debe estar entre -180 y 180")
    private BigDecimal longitud;
    
    @Column(columnDefinition = "TEXT")
    private String descripcion;
    
    @Column(name = "ano_fundacion")
    private Integer anoFundacion;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "usuario_responsable_id")
    private Usuario usuarioResponsable;
    
    @Column(name = "imagen_url", length = 500)
    private String imagenUrl;
    
    @Column(nullable = false)
    private Boolean activa = true;
    
    @Column(name = "fecha_creacion")
    @CreationTimestamp
    private LocalDateTime fechaCreacion;
    
    @Column(name = "fecha_actualizacion")
    @UpdateTimestamp
    private LocalDateTime fechaActualizacion;
    
    // Getters, Setters, Constructor
}
```

---

## 3. DTOs

### 3.1 FallaDTO

```java
public class FallaDTO {
    private Long id;
    private String nombre;
    private String direccion;
    private BigDecimal latitud;
    private BigDecimal longitud;
    private String descripcion;
    private Integer anoFundacion;
    private String imagenUrl;
    private Boolean activa;
    private UsuarioDTO usuarioResponsable; // Puede ser null
    
    // Constructor, Getters, Setters
}
```

### 3.2 CrearFallaRequest

```java
public class CrearFallaRequest {
    
    @NotBlank(message = "Nombre es obligatorio")
    @Size(max = 200, message = "Nombre no puede exceder 200 caracteres")
    private String nombre;
    
    @NotBlank(message = "Dirección es obligatoria")
    @Size(max = 300, message = "Dirección no puede exceder 300 caracteres")
    private String direccion;
    
    @NotNull(message = "Latitud es obligatoria")
    @DecimalMin(value = "-90.0")
    @DecimalMax(value = "90.0")
    private BigDecimal latitud;
    
    @NotNull(message = "Longitud es obligatoria")
    @DecimalMin(value = "-180.0")
    @DecimalMax(value = "180.0")
    private BigDecimal longitud;
    
    @Size(max = 5000, message = "Descripción no puede exceder 5000 caracteres")
    private String descripcion;
    
    private Integer anoFundacion;
    
    private Long usuarioResponsableId; // Opcional, asignado por ADMIN
    
    private String imagenUrl;
    
    // Getters, Setters
}
```

---

## 4. Endpoints API

### 4.1 GET /api/fallas
Lista todas las fallas activas.

**Query Params** (opcionales):
- `activa`: true/false (por defecto: true)
- `buscar`: Texto para buscar en nombre o dirección

**Response (200 OK)**:
```json
{
  "contenido": [
    {
      "id": 1,
      "nombre": "Falla Na Jordana",
      "direccion": "Calle Na Jordana, 25, Valencia",
      "latitud": 39.4699075,
      "longitud": -0.3762881,
      "descripcion": "Falla tradicional del barrio de Ruzafa",
      "anoFundacion": 1942,
      "imagenUrl": "https://example.com/fallas/1.jpg",
      "activa": true,
      "usuarioResponsable": {
        "id": 15,
        "nombre": "Juan",
        "email": "casal1@example.com"
      }
    }
  ],
  "total": 150
}
```

### 4.2 GET /api/fallas/{id}
Obtiene detalle de una falla específica.

**Response (200 OK)**:
```json
{
  "id": 1,
  "nombre": "Falla Na Jordana",
  "direccion": "Calle Na Jordana, 25, Valencia",
  "latitud": 39.4699075,
  "longitud": -0.3762881,
  "descripcion": "Falla tradicional del barrio de Ruzafa...",
  "anoFundacion": 1942,
  "imagenUrl": "https://example.com/fallas/1.jpg",
  "activa": true
}
```

**Errores**:
- `404 Not Found`: Falla no existe

### 4.3 POST /api/fallas (ADMIN o CASAL)
Crea una nueva falla.

**Headers**:
```
Authorization: Bearer {token}
```

**Request**:
```json
{
  "nombre": "Falla Gran Vía",
  "direccion": "Gran Vía Marqués del Turia, 60",
  "latitud": 39.4750891,
  "longitud": -0.3700125,
  "descripcion": "Una de las fallas más emblemáticas de Valencia",
  "anoFundacion": 1932,
  "imagenUrl": "https://example.com/images/falla-gran-via.jpg"
}
```

**Response (201 Created)**:
```json
{
  "id": 151,
  "nombre": "Falla Gran Vía",
  ...
}
```

**Errores**:
- `400 Bad Request`: Datos inválidos
- `401 Unauthorized`: No autenticado
- `403 Forbidden`: Sin permisos

### 4.4 PUT /api/fallas/{id} (ADMIN o propietario CASAL)
Actualiza una falla existente.

**Headers**:
```
Authorization: Bearer {token}
```

**Request**:
```json
{
  "nombre": "Falla Gran Vía - Actualizado",
  "direccion": "Gran Vía Marqués del Turia, 60, Valencia",
  "descripcion": "Descripción actualizada...",
  "imagenUrl": "https://example.com/images/nueva-imagen.jpg"
}
```

**Response (200 OK)**:
```json
{
  "id": 151,
  "nombre": "Falla Gran Vía - Actualizado",
  ...
}
```

**Lógica de permisos**:
- ADMIN: Puede editar cualquier falla
- CASAL: Solo puede editar su propia falla (usuario_responsable_id = su ID)

### 4.5 DELETE /api/fallas/{id} (Solo ADMIN)
Desactiva una falla (soft delete).

**Headers**:
```
Authorization: Bearer {token_admin}
```

**Response (204 No Content)** ó **(200 OK)**:
```json
{
  "mensaje": "Falla desactivada correctamente"
}
```

**Nota**: No se borra físicamente, solo se marca `activa = false`.

---

## 5. Lógica de Negocio (Service)

```java
@Service
public class FallaService {
    
    private static final Logger log = LoggerFactory.getLogger(FallaService.class);
    
    private final FallaRepository fallaRepository;
    private final UsuarioRepository usuarioRepository;
    
    public FallaService(FallaRepository fallaRepository, UsuarioRepository usuarioRepository) {
        this.fallaRepository = fallaRepository;
        this.usuarioRepository = usuarioRepository;
    }
    
    public List<FallaDTO> listarFallas(Boolean activa, String buscar) {
        List<Falla> fallas;
        
        if (buscar != null && !buscar.isBlank()) {
            fallas = fallaRepository.buscarPorNombreODireccion(buscar, activa);
        } else if (activa != null) {
            fallas = fallaRepository.findByActiva(activa);
        } else {
            fallas = fallaRepository.findAll();
        }
        
        return fallas.stream()
            .map(this::convertirADTO)
            .collect(Collectors.toList());
    }
    
    public FallaDTO obtenerPorId(Long id) {
        Falla falla = fallaRepository.findById(id)
            .orElseThrow(() -> new EntityNotFoundException("Falla no encontrada: " + id));
        
        return convertirADTO(falla);
    }
    
    public FallaDTO crearFalla(CrearFallaRequest request, Long usuarioAutenticadoId, Rol rolUsuario) {
        // Validar que el nombre no esté duplicado
        if (fallaRepository.existsByNombre(request.getNombre())) {
            throw new DuplicateEntityException("Ya existe una falla con ese nombre");
        }
        
        Falla falla = new Falla();
        falla.setNombre(request.getNombre());
        falla.setDireccion(request.getDireccion());
        falla.setLatitud(request.getLatitud());
        falla.setLongitud(request.getLongitud());
        falla.setDescripcion(request.getDescripcion());
        falla.setAnoFundacion(request.getAnoFundacion());
        falla.setImagenUrl(request.getImagenUrl());
        falla.setActiva(true);
        
        // Si es CASAL, asignarse automáticamente como responsable
        if (rolUsuario == Rol.CASAL) {
            Usuario usuario = usuarioRepository.findById(usuarioAutenticadoId)
                .orElseThrow(() -> new EntityNotFoundException("Usuario no encontrado"));
            falla.setUsuarioResponsable(usuario);
        }
        
        // Si es ADMIN y especifica usuario responsable
        if (rolUsuario == Rol.ADMIN && request.getUsuarioResponsableId() != null) {
            Usuario responsable = usuarioRepository.findById(request.getUsuarioResponsableId())
                .orElseThrow(() -> new EntityNotFoundException("Usuario responsable no encontrado"));
            falla.setUsuarioResponsable(responsable);
        }
        
        Falla guardada = fallaRepository.save(falla);
        log.info("Falla creada: id={}, nombre={}", guardada.getId(), guardada.getNombre());
        
        return convertirADTO(guardada);
    }
    
    public FallaDTO actualizarFalla(Long id, CrearFallaRequest request, 
                                     Long usuarioAutenticadoId, Rol rolUsuario) {
        Falla falla = fallaRepository.findById(id)
            .orElseThrow(() -> new EntityNotFoundException("Falla no encontrada: " + id));
        
        // Verificar permisos
        if (rolUsuario == Rol.CASAL) {
            if (falla.getUsuarioResponsable() == null || 
                !falla.getUsuarioResponsable().getId().equals(usuarioAutenticadoId)) {
                throw new ForbiddenException("No tienes permisos para editar esta falla");
            }
        }
        
        // Actualizar campos
        falla.setNombre(request.getNombre());
        falla.setDireccion(request.getDireccion());
        falla.setLatitud(request.getLatitud());
        falla.setLongitud(request.getLongitud());
        falla.setDescripcion(request.getDescripcion());
        falla.setAnoFundacion(request.getAnoFundacion());
        falla.setImagenUrl(request.getImagenUrl());
        
        Falla actualizada = fallaRepository.save(falla);
        log.info("Falla actualizada: id={}", id);
        
        return convertirADTO(actualizada);
    }
    
    public void desactivarFalla(Long id) {
        Falla falla = fallaRepository.findById(id)
            .orElseThrow(() -> new EntityNotFoundException("Falla no encontrada: " + id));
        
        falla.setActiva(false);
        fallaRepository.save(falla);
        
        log.info("Falla desactivada: id={}", id);
    }
    
    private FallaDTO convertirADTO(Falla falla) {
        FallaDTO dto = new FallaDTO();
        dto.setId(falla.getId());
        dto.setNombre(falla.getNombre());
        dto.setDireccion(falla.getDireccion());
        dto.setLatitud(falla.getLatitud());
        dto.setLongitud(falla.getLongitud());
        dto.setDescripcion(falla.getDescripcion());
        dto.setAnoFundacion(falla.getAnoFundacion());
        dto.setImagenUrl(falla.getImagenUrl());
        dto.setActiva(falla.getActiva());
        
        if (falla.getUsuarioResponsable() != null) {
            // Convertir usuario a DTO (simplificado)
            UsuarioDTO usuarioDTO = new UsuarioDTO();
            usuarioDTO.setId(falla.getUsuarioResponsable().getId());
            usuarioDTO.setNombre(falla.getUsuarioResponsable().getNombre());
            usuarioDTO.setEmail(falla.getUsuarioResponsable().getEmail());
            dto.setUsuarioResponsable(usuarioDTO);
        }
        
        return dto;
    }
}
```

---

## 6. Repositorio

```java
@Repository
public interface FallaRepository extends JpaRepository<Falla, Long> {
    
    List<Falla> findByActiva(Boolean activa);
    
    @Query("SELECT f FROM Falla f WHERE " +
           "(LOWER(f.nombre) LIKE LOWER(CONCAT('%', :busqueda, '%')) OR " +
           "LOWER(f.direccion) LIKE LOWER(CONCAT('%', :busqueda, '%'))) AND " +
           "f.activa = :activa")
    List<Falla> buscarPorNombreODireccion(@Param("busqueda") String busqueda, 
                                           @Param("activa") Boolean activa);
    
    boolean existsByNombre(String nombre);
    
    List<Falla> findByUsuarioResponsableId(Long usuarioId);
}
```

---

## 7. Pruebas

### 7.1 Prueba de Integración

```java
@SpringBootTest
@AutoConfigureMockMvc
public class FallaIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    @WithMockUser(roles = "ADMIN")
    public void crearFalla_DatosValidos_Exitoso() throws Exception {
        CrearFallaRequest request = new CrearFallaRequest();
        request.setNombre("Falla Test");
        request.setDireccion("Calle Test, 123");
        request.setLatitud(new BigDecimal("39.4699075"));
        request.setLongitud(new BigDecimal("-0.3762881"));
        request.setDescripcion("Descripción de prueba");
        
        mockMvc.perform(post("/api/fallas")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.id").exists())
            .andExpect(jsonPath("$.nombre").value("Falla Test"));
    }
}
```

---

> **Referencia**: Esta especificación es la base para toda la gestión de fallas en el sistema.
