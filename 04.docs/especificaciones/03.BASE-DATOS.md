# Especificación de Base de Datos PostgreSQL

## 1. Visión General

Sistema de base de datos relacional para FallApp que gestiona:
- **Fallas**: Información de asociaciones falleras de Valencia
- **Usuarios**: Autenticación y perfiles (casal, admin, usuario público)
- **Eventos**: Actos de las fallas (plantà, cremà, etc.)
- **Ninots**: Figuras y obras artísticas
- **Votos/Rankings**: Sistema de votación comunitaria

**Motor**: PostgreSQL 13+
**Ubicación**: Contenedor Docker con volumen persistente

---

## 2. Estructura de Tablas

### 2.1 Tabla: `usuarios`

Gestiona acceso y perfiles en la aplicación.

```
Columns:
├── id_usuario (PK)          | SERIAL (AUTO)
├── email                    | VARCHAR(120) UNIQUE NOT NULL
├── contraseña_hash         | VARCHAR(255) NOT NULL
├── nombre_completo         | VARCHAR(255) NOT NULL
├── rol                     | ENUM('admin', 'casal', 'usuario')
├── id_falla (FK)           | INT NULL (refs fallas.id_falla)
├── activo                  | BOOLEAN DEFAULT true
├── fecha_registro          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
├── ultimo_acceso           | TIMESTAMP NULL
└── telefono                | VARCHAR(20) NULL

Índices:
├── email (UNIQUE)
├── id_falla
└── rol
```

**Relaciones**:
- `1:N` con `fallas` (un casal pertenece a una falla)
- `1:N` con `votos` (un usuario puede votar múltiples veces)
- `1:N` con `comentarios` (un usuario puede comentar)

---

### 2.2 Tabla: `fallas`

Datos de cada asociación fallera participante.

```
Columns:
├── id_falla (PK)           | SERIAL (AUTO)
├── nombre                  | VARCHAR(255) UNIQUE NOT NULL
├── seccion                 | VARCHAR(5) NOT NULL (ej: "1A", "7C", "E")
├── fallera                 | VARCHAR(255) (Reina o Infantil)
├── presidente              | VARCHAR(255) NOT NULL
├── artista                 | VARCHAR(255) (Construcctor/Artista)
├── lema                    | TEXT (Tema de la falla)
├── anyo_fundacion          | INT NOT NULL
├── distintivo              | VARCHAR(100) (Categoría: Brillants, Fulles, Argent)
├── url_boceto              | VARCHAR(500) (URL de imagen)
├── experim                 | BOOLEAN DEFAULT false
├── ubicacion_lat           | DECIMAL(10,8)
├── ubicacion_lon           | DECIMAL(11,8)
├── descripcion             | TEXT NULL
├── web_oficial             | VARCHAR(255) NULL
├── telefono_contacto       | VARCHAR(20) NULL
├── email_contacto          | VARCHAR(120) NULL
├── fecha_ultima_actualizacion | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
└── datos_json              | JSONB (Datos brutos para retrocompatibilidad)

Índices:
├── nombre (UNIQUE)
├── seccion
├── anyo_fundacion
├── distintivo
├── ubicacion (GiST para coordenadas)
└── FULL TEXT SEARCH en nombre, lema, artista
```

**Relaciones**:
- `1:N` con `usuarios` (casal de la falla)
- `1:N` con `eventos` (actividades de la falla)
- `1:N` con `ninots` (figuras de la falla)
- `1:N` con `votos` (votos a esta falla)

---

### 2.3 Tabla: `eventos`

Actos y actividades de cada falla.

```
Columns:
├── id_evento (PK)          | SERIAL (AUTO)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── tipo                    | ENUM('plantà', 'cremà', 'ofrenda', 'encuentro', 'otro')
├── nombre                  | VARCHAR(255) NOT NULL
├── descripcion             | TEXT NULL
├── fecha_evento            | TIMESTAMP NOT NULL
├── ubicacion               | VARCHAR(255)
├── direccion               | VARCHAR(255)
├── url_imagen              | VARCHAR(500) NULL
├── participantes_estimado  | INT NULL
├── creado_por (FK)         | INT (refs usuarios.id_usuario)
├── fecha_creacion          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
└── actualizado_por (FK)    | INT NULL

Índices:
├── id_falla
├── tipo
├── fecha_evento
└── creado_por
```

---

### 2.4 Tabla: `ninots`

Figuras artísticas y construcciones.

```
Columns:
├── id_ninot (PK)           | SERIAL (AUTO)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── nombre_ninot            | VARCHAR(255) NOT NULL
├── titulo_obra             | VARCHAR(255) NOT NULL
├── descripcion             | TEXT NULL
├── altura_metros           | DECIMAL(6,2) NULL
├── ancho_metros            | DECIMAL(6,2) NULL
├── material_principal      | VARCHAR(100) (madera, cartón, etc.)
├── url_imagen_principal    | VARCHAR(500)
├── url_imagenes_adicionales | TEXT[] (Array de URLs)
├── artista_constructor     | VARCHAR(255)
├── año_construccion        | INT
├── premiado                | BOOLEAN DEFAULT false
├── categoria_premio        | VARCHAR(100) NULL
├── fecha_creacion          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
└── notas_tecnicas          | TEXT NULL

Índices:
├── id_falla
├── titulo_obra
└── premiado
```

---

### 2.5 Tabla: `votos`

Sistema de votación comunitaria.

```
Columns:
├── id_voto (PK)            | SERIAL (AUTO)
├── id_usuario (FK)         | INT NOT NULL (refs usuarios.id_usuario)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── tipo_voto               | ENUM('me_gusta', 'mejor_ninot', 'mejor_tema')
├── valor                   | INT (1-5 estrellas, o peso en ranking)
├── comentario              | TEXT NULL
├── fecha_voto              | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
├── actualizado             | TIMESTAMP NULL
└── ip_origen               | VARCHAR(45) (IPv4/IPv6)

Índices:
├── id_usuario
├── id_falla
├── tipo_voto
├── fecha_voto
└── UNIQUE(id_usuario, id_falla, tipo_voto) para evitar duplicados
```

**Constraint**: Un usuario puede votar una sola vez por tipo por falla.

---

### 2.6 Tabla: `comentarios`

Sistema de comentarios y feedback.

```
Columns:
├── id_comentario (PK)      | SERIAL (AUTO)
├── id_usuario (FK)         | INT NOT NULL (refs usuarios.id_usuario)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── texto_comentario        | TEXT NOT NULL
├── rating                  | INT (1-5)
├── visible                 | BOOLEAN DEFAULT true
├── fecha_creacion          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
├── fecha_edicion           | TIMESTAMP NULL
└── id_respuesta_a (FK)     | INT NULL (refs comentarios.id_comentario)

Índices:
├── id_usuario
├── id_falla
├── fecha_creacion
└── visible
```

---

## 3. Enumeraciones (ENUM)

```sql
-- Roles de usuario
CREATE TYPE rol_usuario AS ENUM ('admin', 'casal', 'usuario');

-- Tipos de eventos (actualizado con concierto y teatro)
CREATE TYPE tipo_evento AS ENUM (
    'plantà', 'cremà', 'ofrenda', 'encuentro', 
    'concierto', 'teatro', 'otro'
);

-- Tipos de votos
CREATE TYPE tipo_voto AS ENUM ('me_gusta', 'mejor_ninot', 'mejor_tema', 'rating');

-- Categorías de fallas (actualizado con sin_categoria por defecto)
CREATE TYPE categoria_falla AS ENUM (
    'brillants', 'fulles', 'argent', 'especial', 'sin_categoria'
);
```

---

## 4. Relaciones y Restricciones

### Foreign Keys:

| Tabla | Columna | Referencias | Comportamiento |
|-------|---------|-------------|----------------|
| `usuarios` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `eventos` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `eventos` | `creado_por` | `usuarios.id_usuario` | SET NULL |
| `ninots` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `votos` | `id_usuario` | `usuarios.id_usuario` | CASCADE DELETE |
| `votos` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `comentarios` | `id_usuario` | `usuarios.id_usuario` | CASCADE DELETE |
| `comentarios` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |

---

## 5. Índices de Performance

### Full-Text Search:

```sql
-- Búsqueda de fallas por nombre, lema, artista
CREATE INDEX idx_fallas_fts ON fallas USING GIN(
  to_tsvector('spanish', nombre || ' ' || lema || ' ' || artista)
);
```

### Geo-búsqueda:

```sql
-- Para búsquedas de proximidad espacial (PostGIS opcional - deshabilitado por defecto)
-- Ver ADR-004 para justificación de decisión
-- CREATE EXTENSION IF NOT EXISTS postgis;
-- CREATE INDEX idx_fallas_ubicacion ON fallas USING GIST(
--   ll_to_earth(ubicacion_lat, ubicacion_lon)
-- );

-- Alternativa sin PostGIS (implementada):
CREATE INDEX idx_fallas_ubicacion_lat ON fallas(ubicacion_lat);
CREATE INDEX idx_fallas_ubicacion_lon ON fallas(ubicacion_lon);
```

---

## 6. Vistas Especializadas

> **Nota**: Ver [ADR-005](../arquitectura/ADR-005-vistas-vs-queries-backend.md) para justificación de decisión de usar vistas SQL

### 6.1 v_estadisticas_fallas
Métricas completas por falla para dashboard general.

```sql
CREATE VIEW v_estadisticas_fallas AS
SELECT 
    f.id_falla,
    f.nombre,
    f.seccion,
    f.categoria,
    COUNT(DISTINCT v.id_voto) as total_votos,
    AVG(v.valor) as votos_promedio,
    COUNT(DISTINCT c.id_comentario) as total_comentarios,
    COUNT(DISTINCT e.id_evento) as total_eventos,
    COUNT(DISTINCT n.id_ninot) as total_ninots
FROM fallas f
LEFT JOIN votos v ON f.id_falla = v.id_falla
LEFT JOIN comentarios c ON f.id_falla = c.id_falla
LEFT JOIN eventos e ON f.id_falla = e.id_falla
LEFT JOIN ninots n ON f.id_falla = n.id_falla
GROUP BY f.id_falla;
```

### 6.2 v_fallas_mas_votadas
Ranking de fallas por votos para leaderboard.

```sql
CREATE VIEW v_fallas_mas_votadas AS
SELECT 
    f.id_falla,
    f.nombre,
    f.seccion,
    COUNT(v.id_voto) as total_votos,
    AVG(v.valor) as rating_promedio
FROM fallas f
INNER JOIN votos v ON f.id_falla = v.id_falla
WHERE f.activa = true
GROUP BY f.id_falla
ORDER BY total_votos DESC, rating_promedio DESC;
```

### 6.3 v_busqueda_fallas_fts
Helper para búsqueda full-text con índice GIN.

```sql
CREATE VIEW v_busqueda_fallas_fts AS
SELECT 
    f.id_falla,
    f.nombre,
    f.lema,
    f.artista,
    f.seccion,
    to_tsvector('spanish', 
        COALESCE(f.nombre, '') || ' ' || 
        COALESCE(f.lema, '') || ' ' || 
        COALESCE(f.artista, '')
    ) as searchable
FROM fallas f
WHERE f.activa = true;
```

### 6.4 Otras Vistas Implementadas

- **v_fallas_comentarios**: Análisis de comentarios y ratings por falla
- **v_ninots_mas_comentados**: Top ninots más comentados/votados
- **v_actividad_usuarios**: Análisis de usuarios activos (votos + comentarios)
- **v_fallas_por_seccion**: Métricas agregadas por sección
- **v_eventos_proximos**: Calendario de eventos ordenados por fecha
- **v_usuarios_contenido**: Creadores top (eventos + comentarios)

**Total**: 9 vistas especializadas  
**Documentación completa**: [30.vistas.consultas.sql](../../07.datos/scripts/30.vistas.consultas.sql)

---

## 7. Funciones SQL Reutilizables

### 7.1 buscar_fallas(query TEXT)
Búsqueda full-text simplificada con ranking de relevancia.

```sql
CREATE FUNCTION buscar_fallas(query TEXT)
RETURNS TABLE(
    id_falla INTEGER,
    nombre VARCHAR,
    lema TEXT,
    relevancia REAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        v.id_falla,
        v.nombre,
        v.lema,
        ts_rank(v.searchable, plainto_tsquery('spanish', query)) as relevancia
    FROM v_busqueda_fallas_fts v
    WHERE v.searchable @@ plainto_tsquery('spanish', query)
    ORDER BY relevancia DESC;
END;
$$ LANGUAGE plpgsql;
```

**Uso**:
```sql
SELECT * FROM buscar_fallas('monumento');
SELECT * FROM buscar_fallas('valencia');
```

### 7.2 obtener_ranking_fallas(limite INT, tipo VARCHAR)
Rankings dinámicos por tipo de voto.

```sql
CREATE FUNCTION obtener_ranking_fallas(
    limite INT DEFAULT 10, 
    tipo VARCHAR DEFAULT 'rating'
)
RETURNS TABLE(
    id_falla INTEGER,
    nombre VARCHAR,
    total_votos BIGINT,
    promedio NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        f.id_falla,
        f.nombre,
        COUNT(v.id_voto) as total_votos,
        AVG(v.valor) as promedio
    FROM fallas f
    INNER JOIN votos v ON f.id_falla = v.id_falla
    WHERE v.tipo_voto = tipo::tipo_voto
    GROUP BY f.id_falla
    ORDER BY total_votos DESC, promedio DESC
    LIMIT limite;
END;
$$ LANGUAGE plpgsql;
```

**Uso**:
```sql
-- Top 10 mejor rating general
SELECT * FROM obtener_ranking_fallas(10, 'rating');

-- Top 5 mejor ninot
SELECT * FROM obtener_ranking_fallas(5, 'mejor_ninot');
```

---

## 8. Triggers de Auditoría

### 8.1 Función actualizar_timestamp()

```sql
CREATE OR REPLACE FUNCTION actualizar_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.actualizado_en = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 8.2 Triggers Implementados

```sql
-- Usuarios
CREATE TRIGGER trig_usuarios_actualizar_timestamp
    BEFORE UPDATE ON usuarios
    FOR EACH ROW
    EXECUTE FUNCTION actualizar_timestamp();

-- Fallas
CREATE TRIGGER trig_fallas_actualizar_timestamp
    BEFORE UPDATE ON fallas
    FOR EACH ROW
    EXECUTE FUNCTION actualizar_timestamp();

-- Eventos
CREATE TRIGGER trig_eventos_actualizar_timestamp
    BEFORE UPDATE ON eventos
    FOR EACH ROW
    EXECUTE FUNCTION actualizar_timestamp();

-- Ninots
CREATE TRIGGER trig_ninots_actualizar_timestamp
    BEFORE UPDATE ON ninots
    FOR EACH ROW
    EXECUTE FUNCTION actualizar_timestamp();

-- Comentarios
CREATE TRIGGER trig_comentarios_actualizar_timestamp
    BEFORE UPDATE ON comentarios
    FOR EACH ROW
    EXECUTE FUNCTION actualizar_timestamp();
```

**Total**: 5 triggers de auditoría automática

---

## 9. Datos Iniciales (Seeds)

### Importación de Fallas:

Fuente: `/07.datos/raw/falles-fallas.json`

Campos mapeados:
```
JSON → SQL
├── nombre → fallas.nombre
├── seccion → fallas.seccion
├── fallera → fallas.fallera
├── presidente → fallas.presidente
├── artista → fallas.artista
├── lema → fallas.lema
├── anyo_fundacion → fallas.anyo_fundacion
├── distintivo → fallas.distintivo
├── boceto → fallas.url_boceto
├── geo_point_2d.lat → fallas.ubicacion_lat
├── geo_point_2d.lon → fallas.ubicacion_lon
└── (completo) → fallas.datos_json
```

---

## 7. Script de Inicialización

**Ubicación**: `07.datos/scripts/init-db.sql`

Incluye:
1. Creación de extensiones (PostGIS si se usa geolocalización)
2. Creación de tipos ENUM
3. Creación de todas las tablas
4. Creación de índices
5. Configuración de seguridad (row-level security)
6. Script de importación de datos

---

## 8. Volumen Docker Persistente

**Configuración en docker-compose.yml**:

```yaml
services:
  postgres:
    image: postgres:13-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./07.datos/scripts:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_DB: fallapp
      POSTGRES_USER: fallapp_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}

volumes:
  postgres_data:
    driver: local
```

---

## 9. Consideraciones de Seguridad

1. **Hash de contraseñas**: bcrypt + salt (en aplicación, no BD)
2. **Row-Level Security**: Por rol de usuario
3. **Audit Trail**: Timestamps en cada tabla
4. **IP Tracking**: Para detectar fraude en votos
5. **HTTPS**: Requerido para cualquier exposición pública

---

## 10. Roadmap de Mejoras

- [ ] Particionamiento por sección (si crece > 100k registros)
- [ ] Caché en Redis para FTS
- [ ] Replicación para alta disponibilidad
- [ ] Backups automáticos en AWS S3
- [ ] Análisis de tendencias con BI

---

## 11. Notas Técnicas y Decisiones Arquitectónicas

**ADRs (Architecture Decision Records)**:
- [ADR-001](../arquitectura/ADR-001-postgresql-vs-mongodb.md): Elección de PostgreSQL sobre MongoDB
- [ADR-002](../arquitectura/ADR-002-docker-local-development.md): Docker para desarrollo local
- [ADR-003](../arquitectura/ADR-003-nomenclatura-scripts-sql.md): Nomenclatura de scripts SQL
- [ADR-004](../arquitectura/ADR-004-postgis-opcional.md): PostGIS opcional (deshabilitado)
- [ADR-005](../arquitectura/ADR-005-vistas-vs-queries-backend.md): Vistas SQL vs Queries en Backend

**Alternativas consideradas**:

- ❌ MongoDB: No ideal para relaciones complejas (votos, comentarios)
- ✅ PostgreSQL: Mejor para consultas ACID y transacciones
- ❌ Firebase: Dependencia del proveedor, costo escalable

**Decisión final**: PostgreSQL en Docker local, facilita migración a AWS RDS en producción.

**Decisiones técnicas implementadas**:

1. **Vistas SQL para consultas complejas**: 9 vistas especializadas reutilizables
2. **Funciones SQL parametrizadas**: 2 funciones para búsqueda y rankings
3. **Triggers de auditoría**: 5 triggers automáticos para timestamps
4. **PostGIS deshabilitado**: Suficiente con DECIMAL + B-tree para 400 fallas
5. **Nomenclatura NN.tipo.sql**: Scripts ordenados alfabéticamente para Docker

---

Última actualización: 2026-02-01
