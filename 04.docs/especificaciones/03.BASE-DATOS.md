# Especificación de Base de Datos PostgreSQL

## 1. Visión General

Sistema de base de datos relacional para FallApp que gestiona:
- **Fallas**: Información de asociaciones falleras de Valencia
- **Usuarios**: Autenticación y perfiles (casal, admin, usuario público)
- **Eventos**: Actos de las fallas (plantà, cremà, etc.)
- **Ninots**: Figuras y obras artísticas
- **Votos/Rankings**: Sistema de votación comunitaria

**Motor**: PostgreSQL 13+
**Ubicación**: Contenedor Docker con volumen persistente

---

## 2. Estructura de Tablas

### 2.1 Tabla: `usuarios`

Gestiona acceso y perfiles en la aplicación.

```
Columns:
├── id_usuario (PK)          | SERIAL (AUTO)
├── email                    | VARCHAR(120) UNIQUE NOT NULL
├── contraseña_hash         | VARCHAR(255) NOT NULL
├── nombre_completo         | VARCHAR(255) NOT NULL
├── rol                     | ENUM('admin', 'casal', 'usuario')
├── id_falla (FK)           | INT NULL (refs fallas.id_falla)
├── activo                  | BOOLEAN DEFAULT true
├── fecha_registro          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
├── ultimo_acceso           | TIMESTAMP NULL
└── telefono                | VARCHAR(20) NULL

Índices:
├── email (UNIQUE)
├── id_falla
└── rol
```

**Relaciones**:
- `1:N` con `fallas` (un casal pertenece a una falla)
- `1:N` con `votos` (un usuario puede votar múltiples veces)
- `1:N` con `comentarios` (un usuario puede comentar)

---

### 2.2 Tabla: `fallas`

Datos de cada asociación fallera participante.

```
Columns:
├── id_falla (PK)           | SERIAL (AUTO)
├── nombre                  | VARCHAR(255) UNIQUE NOT NULL
├── seccion                 | VARCHAR(5) NOT NULL (ej: "1A", "7C", "E")
├── fallera                 | VARCHAR(255) (Reina o Infantil)
├── presidente              | VARCHAR(255) NOT NULL
├── artista                 | VARCHAR(255) (Construcctor/Artista)
├── lema                    | TEXT (Tema de la falla)
├── anyo_fundacion          | INT NOT NULL
├── distintivo              | VARCHAR(100) (Categoría: Brillants, Fulles, Argent)
├── url_boceto              | VARCHAR(500) (URL de imagen)
├── experim                 | BOOLEAN DEFAULT false
├── ubicacion_lat           | DECIMAL(10,8)
├── ubicacion_lon           | DECIMAL(11,8)
├── descripcion             | TEXT NULL
├── web_oficial             | VARCHAR(255) NULL
├── telefono_contacto       | VARCHAR(20) NULL
├── email_contacto          | VARCHAR(120) NULL
├── fecha_ultima_actualizacion | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
└── datos_json              | JSONB (Datos brutos para retrocompatibilidad)

Índices:
├── nombre (UNIQUE)
├── seccion
├── anyo_fundacion
├── distintivo
├── ubicacion (GiST para coordenadas)
└── FULL TEXT SEARCH en nombre, lema, artista
```

**Relaciones**:
- `1:N` con `usuarios` (casal de la falla)
- `1:N` con `eventos` (actividades de la falla)
- `1:N` con `ninots` (figuras de la falla)
- `1:N` con `votos` (votos a esta falla)

---

### 2.3 Tabla: `eventos`

Actos y actividades de cada falla.

```
Columns:
├── id_evento (PK)          | SERIAL (AUTO)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── tipo                    | ENUM('plantà', 'cremà', 'ofrenda', 'encuentro', 'otro')
├── nombre                  | VARCHAR(255) NOT NULL
├── descripcion             | TEXT NULL
├── fecha_evento            | TIMESTAMP NOT NULL
├── ubicacion               | VARCHAR(255)
├── direccion               | VARCHAR(255)
├── url_imagen              | VARCHAR(500) NULL
├── participantes_estimado  | INT NULL
├── creado_por (FK)         | INT (refs usuarios.id_usuario)
├── fecha_creacion          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
└── actualizado_por (FK)    | INT NULL

Índices:
├── id_falla
├── tipo
├── fecha_evento
└── creado_por
```

---

### 2.4 Tabla: `ninots`

Figuras artísticas y construcciones.

```
Columns:
├── id_ninot (PK)           | SERIAL (AUTO)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── nombre_ninot            | VARCHAR(255) NOT NULL
├── titulo_obra             | VARCHAR(255) NOT NULL
├── descripcion             | TEXT NULL
├── altura_metros           | DECIMAL(6,2) NULL
├── ancho_metros            | DECIMAL(6,2) NULL
├── material_principal      | VARCHAR(100) (madera, cartón, etc.)
├── url_imagen_principal    | VARCHAR(500)
├── url_imagenes_adicionales | TEXT[] (Array de URLs)
├── artista_constructor     | VARCHAR(255)
├── año_construccion        | INT
├── premiado                | BOOLEAN DEFAULT false
├── categoria_premio        | VARCHAR(100) NULL
├── fecha_creacion          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
└── notas_tecnicas          | TEXT NULL

Índices:
├── id_falla
├── titulo_obra
└── premiado
```

---

### 2.5 Tabla: `votos`

Sistema de votación comunitaria.

```
Columns:
├── id_voto (PK)            | SERIAL (AUTO)
├── id_usuario (FK)         | INT NOT NULL (refs usuarios.id_usuario)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── tipo_voto               | ENUM('me_gusta', 'mejor_ninot', 'mejor_tema')
├── valor                   | INT (1-5 estrellas, o peso en ranking)
├── comentario              | TEXT NULL
├── fecha_voto              | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
├── actualizado             | TIMESTAMP NULL
└── ip_origen               | VARCHAR(45) (IPv4/IPv6)

Índices:
├── id_usuario
├── id_falla
├── tipo_voto
├── fecha_voto
└── UNIQUE(id_usuario, id_falla, tipo_voto) para evitar duplicados
```

**Constraint**: Un usuario puede votar una sola vez por tipo por falla.

---

### 2.6 Tabla: `comentarios`

Sistema de comentarios y feedback.

```
Columns:
├── id_comentario (PK)      | SERIAL (AUTO)
├── id_usuario (FK)         | INT NOT NULL (refs usuarios.id_usuario)
├── id_falla (FK)           | INT NOT NULL (refs fallas.id_falla)
├── texto_comentario        | TEXT NOT NULL
├── rating                  | INT (1-5)
├── visible                 | BOOLEAN DEFAULT true
├── fecha_creacion          | TIMESTAMP DEFAULT CURRENT_TIMESTAMP
├── fecha_edicion           | TIMESTAMP NULL
└── id_respuesta_a (FK)     | INT NULL (refs comentarios.id_comentario)

Índices:
├── id_usuario
├── id_falla
├── fecha_creacion
└── visible
```

---

## 3. Enumeraciones (ENUM)

```sql
-- Roles de usuario
CREATE TYPE rol_usuario AS ENUM ('admin', 'casal', 'usuario');

-- Tipos de eventos
CREATE TYPE tipo_evento AS ENUM ('plantà', 'cremà', 'ofrenda', 'encuentro', 'otro');

-- Tipos de votos
CREATE TYPE tipo_voto_enum AS ENUM ('me_gusta', 'mejor_ninot', 'mejor_tema');
```

---

## 4. Relaciones y Restricciones

### Foreign Keys:

| Tabla | Columna | Referencias | Comportamiento |
|-------|---------|-------------|----------------|
| `usuarios` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `eventos` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `eventos` | `creado_por` | `usuarios.id_usuario` | SET NULL |
| `ninots` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `votos` | `id_usuario` | `usuarios.id_usuario` | CASCADE DELETE |
| `votos` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |
| `comentarios` | `id_usuario` | `usuarios.id_usuario` | CASCADE DELETE |
| `comentarios` | `id_falla` | `fallas.id_falla` | CASCADE DELETE |

---

## 5. Índices de Performance

### Full-Text Search:

```sql
-- Búsqueda de fallas por nombre, lema, artista
CREATE INDEX idx_fallas_fts ON fallas USING GIN(
  to_tsvector('spanish', nombre || ' ' || lema || ' ' || artista)
);
```

### Geo-búsqueda:

```sql
-- Para búsquedas de proximidad espacial
CREATE INDEX idx_fallas_ubicacion ON fallas USING GIST(
  ll_to_earth(ubicacion_lat, ubicacion_lon)
);
```

---

## 6. Datos Iniciales (Seeds)

### Importación de Fallas:

Fuente: `/07.datos/raw/falles-fallas.json`

Campos mapeados:
```
JSON → SQL
├── nombre → fallas.nombre
├── seccion → fallas.seccion
├── fallera → fallas.fallera
├── presidente → fallas.presidente
├── artista → fallas.artista
├── lema → fallas.lema
├── anyo_fundacion → fallas.anyo_fundacion
├── distintivo → fallas.distintivo
├── boceto → fallas.url_boceto
├── geo_point_2d.lat → fallas.ubicacion_lat
├── geo_point_2d.lon → fallas.ubicacion_lon
└── (completo) → fallas.datos_json
```

---

## 7. Script de Inicialización

**Ubicación**: `07.datos/scripts/init-db.sql`

Incluye:
1. Creación de extensiones (PostGIS si se usa geolocalización)
2. Creación de tipos ENUM
3. Creación de todas las tablas
4. Creación de índices
5. Configuración de seguridad (row-level security)
6. Script de importación de datos

---

## 8. Volumen Docker Persistente

**Configuración en docker-compose.yml**:

```yaml
services:
  postgres:
    image: postgres:13-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./07.datos/scripts:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_DB: fallapp
      POSTGRES_USER: fallapp_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}

volumes:
  postgres_data:
    driver: local
```

---

## 9. Consideraciones de Seguridad

1. **Hash de contraseñas**: bcrypt + salt (en aplicación, no BD)
2. **Row-Level Security**: Por rol de usuario
3. **Audit Trail**: Timestamps en cada tabla
4. **IP Tracking**: Para detectar fraude en votos
5. **HTTPS**: Requerido para cualquier exposición pública

---

## 10. Roadmap de Mejoras

- [ ] Particionamiento por sección (si crece > 100k registros)
- [ ] Caché en Redis para FTS
- [ ] Replicación para alta disponibilidad
- [ ] Backups automáticos en AWS S3
- [ ] Análisis de tendencias con BI

---

## 11. Notas Técnicas

**Alternativas consideradas:**

- ❌ MongoDB: No ideal para relaciones complejas (votos, comentarios)
- ✅ PostgreSQL: Mejor para consultas ACID y transacciones
- ❌ Firebase: Dependencia del proveedor, costo escalable

**Decisión final**: PostgreSQL en Docker local, facilita migración a AWS RDS en producción.

---

Última actualización: 2026-02-01
